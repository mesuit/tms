<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin â€¢ Time Shop Save</title>

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%237b2ff7'/><stop offset='1' stop-color='%23ff6ec7'/></linearGradient></defs><rect width='100' height='100' rx='16' fill='url(%23g)'/><text x='50' y='60' font-family='Inter,Arial,sans-serif' font-weight='800' font-size='28' text-anchor='middle' fill='%23070416'>TSS</text></svg>">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{--bg:#0b0b14;--panel:#0f1220;--muted:rgba(234,243,255,0.6);--text:#eaf3ff;--accent1:#7b2ff7;--accent2:#ff6ec7;--card:#0d0f1a;--glass:rgba(255,255,255,0.03);--success:#2be72b;--danger:#ff4b4b;}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,sans-serif;background:linear-gradient(180deg,#070417 0%,#0b0b14 100%);color:var(--text);min-height:100vh}
    .app{display:flex;gap:18px;max-width:1400px;margin:18px auto;padding:18px;align-items:flex-start;}
    .sidebar{width:280px;background:var(--panel);border-radius:14px;padding:18px;border:1px solid var(--glass);flex-shrink:0;height:calc(100vh - 40px);}
    .logo{font-size:20px;font-weight:900;color:var(--accent1);margin-bottom:20px;}
    .menu button{width:100%;padding:12px;background:transparent;border:none;color:var(--muted);text-align:left;cursor:pointer;border-radius:8px;margin-bottom:4px;display:flex;align-items:center;gap:10px;}
    .menu button:hover, .menu button.active{background:rgba(123,47,247,0.1);color:var(--text);}
    .main{flex:1;display:flex;flex-direction:column;gap:14px;}
    .card{background:var(--card);padding:20px;border-radius:12px;border:1px solid var(--glass);margin-bottom:14px;}
    .kpis{display:flex;gap:14px;flex-wrap:wrap;}
    .kpi{flex:1;background:var(--glass);padding:20px;border-radius:12px;min-width:200px;}
    .kpi h3{margin:0;color:var(--muted);font-size:12px;}
    .kpi .val{font-size:24px;font-weight:800;margin-top:8px;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:12px;border-bottom:1px solid var(--glass);text-align:left;}
    th{color:var(--muted);}
    .btn{padding:8px 16px;border-radius:6px;border:none;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#000;font-weight:700;cursor:pointer;}
    .btn.ghost{background:transparent;border:1px solid var(--glass);color:var(--text);}
    .status-pending{color:orange;} .status-completed{color:var(--success);}
    input{background:var(--glass);border:1px solid #333;padding:10px;color:#fff;border-radius:6px;width:100%;}
  </style>
</head>
<body>

<div id="loginOverlay" style="position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;justify-content:center;align-items:center;">
  <div class="card" style="width:350px;text-align:center;">
    <h2 style="margin-bottom:20px;">Admin Login</h2>
    <input id="adminEmail" placeholder="admin@gmail.com" style="margin-bottom:10px;">
    <input id="adminPass" type="password" placeholder="admin123" style="margin-bottom:20px;">
    <button class="btn" onclick="attemptLogin()" style="width:100%">Enter Dashboard</button>
    <p id="loginErr" style="color:var(--danger);font-size:12px;margin-top:10px;display:none;">Invalid Credentials</p>
  </div>
</div>

<div class="app" id="appContent" style="filter:blur(5px);pointer-events:none;">
  <aside class="sidebar">
    <div class="logo">TSS Admin</div>
    <div class="menu">
      <button class="active" onclick="showPanel('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</button>
      <button onclick="showPanel('withdrawals')"><i class="fas fa-wallet"></i> Withdrawals</button>
      <button onclick="showPanel('shops')"><i class="fas fa-store"></i> Shops</button>
      <button onclick="showPanel('customers')"><i class="fas fa-users"></i> Customers</button>
      <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </aside>

  <main class="main">
    
    <div id="panel-dashboard">
      <div class="kpis">
        <div class="kpi"><h3>Total Revenue</h3><div class="val" id="totalRev">Ksh 0</div></div>
        <div class="kpi"><h3>Pending Withdrawals</h3><div class="val" id="pendingCount">0</div></div>
        <div class="kpi"><h3>Total Shops</h3><div class="val" id="shopCount">0</div></div>
        <div class="kpi"><h3>Total Customers</h3><div class="val" id="custCount">0</div></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;margin-bottom:15px;">
          <h3>Recent Orders</h3>
          <button class="btn ghost" onclick="loadDashboard()">Refresh</button>
        </div>
        <div style="max-height:400px;overflow:auto;">
          <table id="ordersTable">
            <thead><tr><th>Date</th><th>Shop</th><th>Amount</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="panel-withdrawals" style="display:none;">
      <div class="card">
        <h3>Withdrawal Requests</h3>
        <p style="font-size:13px;color:var(--muted);margin-bottom:15px;">
          Requests below include the specific M-Pesa number entered by the shopkeeper.
        </p>
        <div style="overflow:auto;">
          <table id="withdrawTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Shop Owner</th>
                <th>M-Pesa Number</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="panel-shops" style="display:none;">
      <div class="card">
        <h3>Registered Shops</h3>
        <table id="shopsTable">
          <thead><tr><th>Name</th><th>Category</th><th>Owner Email</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="panel-customers" style="display:none;">
      <div class="card">
        <h3>Registered Customers</h3>
        <table id="customersTable">
          <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Date Registered</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </main>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// --- CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyCws2eOt3muKCpjHIxB3vUlOHGA06xLhtc",
  authDomain: "time-shop-save.firebaseapp.com",
  projectId: "time-shop-save",
  storageBucket: "time-shop-save.firebasestorage.app",
  messagingSenderId: "1037284454386",
  appId: "1:1037284454386:web:a863e690cc63049e1cc56b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- LOGIN LOGIC ---
function attemptLogin() {
  const e = document.getElementById('adminEmail').value;
  const p = document.getElementById('adminPass').value;
  
  if(e === 'admin@gmail.com' && p === 'admin123') {
    document.getElementById('loginOverlay').style.display = 'none';
    const app = document.getElementById('appContent');
    app.style.filter = 'none';
    app.style.pointerEvents = 'all';
    loadDashboard();
  } else {
    document.getElementById('loginErr').style.display = 'block';
  }
}

function logout() {
  location.reload();
}

// --- DASHBOARD DATA ---
async function loadDashboard() {
  // 1. Orders & Revenue
  const ordersSnap = await db.collection('orders').orderBy('createdAt', 'desc').get();
  let total = 0;
  const tbody = document.querySelector('#ordersTable tbody');
  tbody.innerHTML = '';

  ordersSnap.forEach(doc => {
    const o = doc.data();
    total += Number(o.total || 0);
    tbody.innerHTML += `
      <tr>
        <td>${new Date(o.createdAt).toLocaleDateString()}</td>
        <td>${o.shopName}</td>
        <td>Ksh ${o.total}</td>
        <td>${o.status}</td>
      </tr>
    `;
  });
  document.getElementById('totalRev').textContent = "Ksh " + total.toLocaleString();

  // 2. Shops Count
  const shopsSnap = await db.collection('shopkeepers').get();
  document.getElementById('shopCount').textContent = shopsSnap.size;
  
  const shopsTbody = document.querySelector('#shopsTable tbody');
  shopsTbody.innerHTML = '';
  shopsSnap.forEach(doc => {
    const s = doc.data();
    shopsTbody.innerHTML += `<tr><td>${s.shopName}</td><td>${s.category}</td><td>${s.email}</td></tr>`;
  });

  // 3. Customers Count
  const custSnap = await db.collection('users').where('role', '==', 'customer').get();
  document.getElementById('custCount').textContent = custSnap.size;
  
  const custTbody = document.querySelector('#customersTable tbody');
  custTbody.innerHTML = '';
  custSnap.forEach(doc => {
    const c = doc.data();
    const date = c.dateRegistered ? new Date(c.dateRegistered).toLocaleDateString() : 'N/A';
    custTbody.innerHTML += `<tr><td>${c.name}</td><td>${c.email}</td><td>${c.phone}</td><td>${date}</td></tr>`;
  });

  // 4. Load Withdrawals
  loadWithdrawals();
}

// --- UPDATED WITHDRAWAL LOGIC ---
async function loadWithdrawals() {
  const snap = await db.collection('withdrawals').orderBy('date', 'desc').get();
  const tbody = document.querySelector('#withdrawTable tbody');
  tbody.innerHTML = '';
  
  let pending = 0;

  const promises = snap.docs.map(async (doc) => {
    const w = doc.data();
    const id = doc.id;
    
    if(w.status === 'pending') pending++;

    // --- NEW LOGIC: Prefer M-Pesa Number from Request ---
    let phone = w.mpesaNumber;

    // Fallback: If not in request, try profile
    if(!phone && w.shopId) {
      let userDoc = await db.collection('shopkeepers').doc(w.shopId).get();
      if(!userDoc.exists) userDoc = await db.collection('users').doc(w.shopId).get();
      
      if(userDoc.exists) {
        phone = userDoc.data().phone;
      }
    }
    
    phone = phone || "Unknown"; // Final fallback

    const statusColor = w.status === 'pending' ? 'orange' : 'green';
    const actionBtn = w.status === 'pending' 
      ? `<button class="btn" style="font-size:12px;padding:5px 10px;" onclick="markPaid('${id}')">Mark Paid</button>` 
      : `<i class="fas fa-check" style="color:lime"></i>`;

    return `
      <tr>
        <td>${new Date(w.date).toLocaleDateString()}</td>
        <td>${w.shopOwnerEmail}</td>
        <td style="font-weight:bold;color:var(--accent1);font-size:14px;">${phone}</td>
        <td>Ksh ${w.amount}</td>
        <td style="color:${statusColor}">${w.status.toUpperCase()}</td>
        <td>${actionBtn}</td>
      </tr>
    `;
  });

  const rows = await Promise.all(promises);
  tbody.innerHTML = rows.join('');
  document.getElementById('pendingCount').textContent = pending;
}

window.markPaid = async function(id) {
  if(confirm("Have you processed the M-Pesa payment? Mark this as Completed?")) {
    await db.collection('withdrawals').doc(id).update({ status: 'completed' });
    loadWithdrawals(); 
    alert("Withdrawal marked as completed.");
  }
}

// --- NAVIGATION ---
window.showPanel = function(id) {
  ['dashboard', 'withdrawals', 'shops', 'customers'].forEach(p => {
    document.getElementById('panel-' + p).style.display = 'none';
  });
  document.getElementById('panel-' + id).style.display = 'block';
}
</script>
</body>
</html>