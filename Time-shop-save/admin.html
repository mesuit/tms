<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Portal â€¢ TSS</title>

  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --primary: #7367f0; --success: #28c76f; --warning: #ff9f43; --danger: #ea5455; --info: #00cfe8;
      --dark-sidebar: #111c44; --body-bg: #f4f6f9; --card-bg: #ffffff; 
      --text-main: #333; --text-muted: #888;
      --sidebar-width: 250px;
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Public Sans', sans-serif; background-color: var(--body-bg); color: var(--text-main); display: flex; min-height: 100vh; overflow: hidden; }

    /* SIDEBAR */
    aside { width: var(--sidebar-width); background: var(--dark-sidebar); color: #fff; display: flex; flex-direction: column; height: 100vh; transition: 0.3s; flex-shrink: 0; }
    .brand { height: 70px; display: flex; align-items: center; padding: 0 20px; font-size: 20px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .brand span { color: var(--primary); margin-left: 5px; }
    
    .menu { padding: 15px; flex: 1; overflow-y: auto; }
    .menu-label { font-size: 11px; text-transform: uppercase; color: rgba(255,255,255,0.4); margin: 15px 0 5px 10px; font-weight: 600; }
    
    .nav-item { display: flex; align-items: center; padding: 12px 15px; border-radius: 8px; color: rgba(255,255,255,0.7); cursor: pointer; transition: 0.2s; font-size: 14px; margin-bottom: 4px; }
    .nav-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .nav-item.active { background: var(--primary); color: #fff; box-shadow: 0 4px 15px rgba(115, 103, 240, 0.4); }
    .nav-item i { width: 20px; margin-right: 10px; font-size: 16px; }

    /* BOTTOM SIDEBAR (User Creation) */
    .sidebar-footer { padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); }

    /* MAIN CONTENT */
    .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow-y: auto; }
    header { background: var(--card-bg); height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; box-shadow: 0 2px 15px rgba(0,0,0,0.04); position: sticky; top: 0; z-index: 50; }
    .header-title { font-size: 18px; font-weight: 600; }
    .admin-profile { display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 14px; }
    .admin-avatar { width: 35px; height: 35px; background: var(--primary); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

    .page-wrapper { padding: 30px; }
    
    /* CARDS & TABLES */
    .widgets-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .widget-card { background: var(--card-bg); border-radius: 12px; padding: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 10px rgba(0,0,0,0.02); border: 1px solid rgba(0,0,0,0.05); }
    .widget-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
    .bg-light-primary { background: rgba(115, 103, 240, 0.1); color: var(--primary); }
    .bg-light-success { background: rgba(40, 199, 111, 0.1); color: var(--success); }
    .bg-light-warning { background: rgba(255, 159, 67, 0.1); color: var(--warning); }
    .widget-info h4 { margin: 0; font-size: 14px; color: var(--text-muted); font-weight: 500; }
    .widget-info h2 { margin: 5px 0 0; font-size: 24px; font-weight: 700; color: #333; }

    .table-container { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
    .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th { text-align: left; padding: 12px 15px; color: var(--text-muted); font-weight: 600; background: #f8f9fa; text-transform: uppercase; font-size: 12px; }
    td { padding: 12px 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
    
    .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
    .st-active { background: rgba(40, 199, 111, 0.1); color: var(--success); }
    .st-suspended { background: rgba(234, 84, 85, 0.1); color: var(--danger); }
    .st-pending { background: rgba(255, 159, 67, 0.1); color: var(--warning); }

    .chart-box { background: #fff; padding: 25px; border-radius: 12px; height: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }

    .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-outline { border: 1px solid #ddd; background: transparent; color: #555; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }

    .hidden { display: none !important; }
    #loginOverlay, #modalOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-box { background: #fff; padding: 30px; border-radius: 12px; width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #555; }
    .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
  </style>
</head>
<body>

  <div id="loginOverlay">
    <div class="modal-box" style="text-align:center;">
      <h2 style="color:var(--primary);">Admin Portal</h2>
      <input id="adminEmail" class="form-control" placeholder="admin@gmail.com" style="margin-bottom:10px;">
      <input id="adminPass" class="form-control" type="password" placeholder="admin123" style="margin-bottom:20px;">
      <button class="btn btn-primary" onclick="attemptLogin()" style="width:100%; justify-content:center;">Login</button>
      <p id="loginErr" style="color:var(--danger); margin-top:10px; display:none;">Access Denied</p>
    </div>
  </div>

  <div id="modalOverlay" class="hidden">
    <div class="modal-box">
      <h3 style="margin-top:0">Create New User</h3>
      <div class="form-group"><label>Name / Shop Name</label><input id="newUserName" class="form-control"></div>
      <div class="form-group"><label>Email</label><input id="newUserEmail" class="form-control"></div>
      <div class="form-group"><label>Password</label><input id="newUserPass" class="form-control" type="password"></div>
      <div class="form-group"><label>Role</label>
        <select id="newUserRole" class="form-control">
          <option value="customer">Customer</option>
          <option value="shop">Shopkeeper</option>
        </select>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
        <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" id="btnCreateUser" onclick="submitNewUser()">Create</button>
      </div>
    </div>
  </div>

  <aside>
    <div class="brand">TIME SHOP<span>SAVE</span></div>
    <div class="menu">
      <div class="menu-label">Main</div>
      <div class="nav-item active" onclick="showPanel('dashboard', this)"><i class="fas fa-home"></i> Dashboard</div>
      
      <div class="menu-label">Management</div>
      <div class="nav-item" onclick="showPanel('orders', this)"><i class="fas fa-receipt"></i> All Orders</div>
      <div class="nav-item" onclick="showPanel('customers', this)"><i class="fas fa-users"></i> Customers</div>
      <div class="nav-item" onclick="showPanel('shops', this)"><i class="fas fa-store"></i> Shops</div>
      <div class="nav-item" onclick="showPanel('withdrawals', this)"><i class="fas fa-wallet"></i> Withdrawals</div>

      <div class="menu-label">Reports</div>
      <div class="nav-item" onclick="showPanel('reports', this)"><i class="fas fa-chart-bar"></i> Sales Report</div>
    </div>

    <div class="sidebar-footer">
        <div class="nav-item" onclick="openModal('shop')"><i class="fas fa-plus-circle"></i> Create User</div>
        <div class="nav-item" style="color:var(--danger)" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </div>
  </aside>

  <div class="main-content">
    <header>
      <div class="header-title">Admin Dashboard</div>
      <div class="admin-profile">
        <div class="admin-avatar">A</div> Administrator
      </div>
    </header>

    <div class="page-wrapper">
      
      <div id="panel-dashboard">
        <div class="widgets-grid">
          <div class="widget-card">
            <div class="widget-info"><h4>Total Revenue</h4><h2 id="totalRev">0</h2></div>
            <div class="widget-icon bg-light-success"><i class="fas fa-money-bill"></i></div>
          </div>
          <div class="widget-card">
            <div class="widget-info"><h4>Active Users</h4><h2 id="totalUsers">0</h2></div>
            <div class="widget-icon bg-light-primary"><i class="fas fa-users"></i></div>
          </div>
          <div class="widget-card">
            <div class="widget-info"><h4>Withdrawals</h4><h2 id="pendingCount">0</h2></div>
            <div class="widget-icon bg-light-warning"><i class="fas fa-clock"></i></div>
          </div>
        </div>

        <div class="table-container">
          <div class="table-header"><h3>Recent Orders</h3></div>
          <table id="dashOrdersTable">
            <thead><tr><th>Date</th><th>Shop</th><th>Amount</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="panel-customers" class="hidden">
        <div class="table-container">
          <div class="table-header">
            <h3>Manage Customers</h3>
            <button class="btn btn-outline" onclick="exportCSV('customers')"><i class="fas fa-download"></i> Export</button>
          </div>
          <table id="customersTable">
            <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="panel-shops" class="hidden">
        <div class="table-container">
          <div class="table-header">
            <h3>Manage Shops</h3>
            <button class="btn btn-outline" onclick="exportCSV('shops')"><i class="fas fa-download"></i> Export</button>
          </div>
          <table id="shopsTable">
            <thead><tr><th>Shop Name</th><th>Email</th><th>Status</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="panel-withdrawals" class="hidden">
        <div class="table-container">
          <div class="table-header"><h3>Withdrawal Requests</h3> <button class="btn btn-outline" onclick="loadWithdrawals()">Refresh</button></div>
          <table id="withdrawTable">
            <thead><tr><th>Date</th><th>Shop</th><th>M-Pesa</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      
       <div id="panel-orders" class="hidden">
        <div class="table-container">
          <div class="table-header"><h3>All Orders</h3> <button class="btn btn-outline" onclick="loadAllOrders()">Refresh</button></div>
          <table id="allOrdersTable">
            <thead><tr><th>Date</th><th>Customer</th><th>Shop</th><th>Items</th><th>Amount</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="panel-reports" class="hidden">
        <div class="chart-box">
          <canvas id="salesChart"></canvas>
        </div>
      </div>

    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
  // --- CONFIG ---
  const firebaseConfig = {
    apiKey: "AIzaSyCws2eOt3muKCpjHIxB3vUlOHGA06xLhtc",
    authDomain: "time-shop-save.firebaseapp.com",
    projectId: "time-shop-save",
    storageBucket: "time-shop-save.firebasestorage.app",
    messagingSenderId: "1037284454386",
    appId: "1:1037284454386:web:a863e690cc63049e1cc56b"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary"); 
  const secondaryAuth = secondaryApp.auth();

  // --- LOGIN ---
  function attemptLogin() {
    const e = document.getElementById('adminEmail').value;
    const p = document.getElementById('adminPass').value;
    if(e === 'admin@gmail.com' && p === 'admin123') {
      document.getElementById('loginOverlay').style.display = 'none';
      loadDashboard();
    } else { document.getElementById('loginErr').style.display = 'block'; }
  }
  function logout() { location.reload(); }

  // --- NAV ---
  window.showPanel = function(id, btn) {
    document.querySelectorAll('[id^="panel-"]').forEach(p => p.classList.add('hidden'));
    document.getElementById('panel-'+id).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    if(btn) btn.classList.add('active');

    if(id === 'dashboard') loadDashboard();
    if(id === 'customers') loadUsers('customer');
    if(id === 'shops') loadUsers('shop');
    if(id === 'withdrawals') loadWithdrawals();
    if(id === 'orders') loadAllOrders();
    if(id === 'reports') loadChart();
  }

  // --- DATA LOADING (OPTIMIZED) ---
  let exportDataBuffer = [];

  async function loadDashboard() {
    const orders = await db.collection('orders').limit(10).get();
    let rev = 0;
    const tbody = document.querySelector('#dashOrdersTable tbody');
    let html = '';
    orders.forEach(d => {
      const o = d.data();
      rev += Number(o.total||0);
      html += `<tr><td>${new Date(o.createdAt).toLocaleDateString()}</td><td>${o.shopName}</td><td>Ksh ${o.total}</td><td><span class="status-badge st-active">Paid</span></td></tr>`;
    });
    tbody.innerHTML = html;
    
    document.getElementById('totalRev').textContent = "KSH " + rev.toLocaleString();
    const users = await db.collection('users').get();
    document.getElementById('totalUsers').textContent = users.size;
  }

  async function loadUsers(role) {
    const tableId = role==='shop' ? 'shopsTable' : 'customersTable';
    const tbody = document.querySelector(`#${tableId} tbody`);
    tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
    
    let collection = role==='shop' ? 'shopkeepers' : 'users';
    let snap = await db.collection(collection).get();
    if(role==='shop' && snap.empty) snap = await db.collection('users').where('role','==','shop').get();
    if(role==='customer') snap = await db.collection('users').where('role','==','customer').get();

    exportDataBuffer = [];
    let html = '';

    snap.forEach(doc => {
      const u = doc.data();
      exportDataBuffer.push(u);
      
      const status = u.status === 'suspended' ? 'Suspended' : 'Active';
      const badgeClass = status === 'Active' ? 'st-active' : 'st-suspended';
      const btnText = status === 'Active' ? 'Block' : 'Unblock';
      const btnCls = status === 'Active' ? 'btn-danger' : 'btn-primary';
      
      html += `<tr>
        <td>${u.name || u.shopName}</td>
        <td>${u.email}</td>
        ${role==='customer' ? `<td>${u.phone||'-'}</td>` : ''}
        <td><span class="status-badge ${badgeClass}">${status}</span></td>
        <td><button class="btn ${btnCls}" style="padding:4px 10px;font-size:11px;" onclick="toggleUser('${doc.id}', '${collection}', '${u.status}')">${btnText}</button></td>
      </tr>`;
    });
    
    tbody.innerHTML = html || '<tr><td colspan="5">No records found</td></tr>';
  }
  
  async function loadAllOrders() {
      const tbody = document.querySelector('#allOrdersTable tbody');
      tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
      const snap = await db.collection('orders').orderBy('createdAt', 'desc').limit(50).get();
      let html = '';
      snap.forEach(doc => {
          const o = doc.data();
          const items = (o.items || []).map(i => i.name).join(', ');
          html += `<tr>
            <td>${new Date(o.createdAt).toLocaleDateString()}</td>
            <td>${o.customerEmail || 'Guest'}</td>
            <td>${o.shopName}</td>
            <td><small>${items.substring(0, 30)}...</small></td>
            <td>Ksh ${o.total}</td>
            <td><span class="status-badge st-active">${o.status}</span></td>
          </tr>`;
      });
      tbody.innerHTML = html || '<tr><td colspan="6">No orders found</td></tr>';
  }

  window.toggleUser = async (id, col, status) => {
    const newStat = status === 'suspended' ? 'Active' : 'suspended';
    if(confirm(`Change status to ${newStat}?`)) {
      await db.collection(col).doc(id).update({ status: newStat });
      loadUsers(col === 'shopkeepers' ? 'shop' : 'customer');
    }
  }

  // --- ADD USER MODAL ---
  window.openModal = (role) => {
    document.getElementById('modalOverlay').classList.remove('hidden');
    document.getElementById('newUserRole').value = role;
  }
  window.closeModal = () => document.getElementById('modalOverlay').classList.add('hidden');

  window.submitNewUser = async () => {
    const name = document.getElementById('newUserName').value;
    const email = document.getElementById('newUserEmail').value;
    const pass = document.getElementById('newUserPass').value;
    const role = document.getElementById('newUserRole').value;
    const btn = document.getElementById('btnCreateUser');
    
    if(!name || !email || !pass) return alert("Fill all fields");
    
    btn.textContent = "Creating...";
    btn.disabled = true;

    try {
      const cred = await secondaryAuth.createUserWithEmailAndPassword(email, pass);
      const col = role === 'shop' ? 'shopkeepers' : 'users';
      
      await db.collection(col).doc(cred.user.uid).set({
        name, email, role, status: 'Active',
        createdAt: new Date().toISOString(),
        ...(role==='shop' && { shopName: name, category: 'General' })
      });
      
      await secondaryAuth.signOut();
      alert("Created Successfully!");
      closeModal();
      loadUsers(role); 
    } catch(e) { alert("Error: "+e.message); }
    
    btn.textContent = "Create";
    btn.disabled = false;
  }

  // --- EXPORT CSV ---
  window.exportCSV = (filename) => {
    if(!window.currentExportData || window.currentExportData.length === 0) return alert("No data to export");
    const items = window.currentExportData;
    const replacer = (key, value) => value === null ? '' : value; 
    const header = Object.keys(items[0]);
    let csv = items.map(row => header.map(f => JSON.stringify(row[f], replacer)).join(','));
    csv.unshift(header.join(','));
    const blob = new Blob([csv.join('\r\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename+'.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }

  // --- WITHDRAWALS ---
  async function loadWithdrawals() {
    const snap = await db.collection('withdrawals').orderBy('date', 'desc').get();
    const tbody = document.querySelector('#withdrawTable tbody');
    let html = '';
    let pending = 0;
    
    const promises = snap.docs.map(async doc => {
      const w = doc.data();
      if(w.status === 'pending') pending++;
      
      let phone = w.mpesaNumber;
      if(!phone && w.shopId) {
        let u = await db.collection('shopkeepers').doc(w.shopId).get();
        if(u.exists) phone = u.data().phone;
      }

      const badge = w.status==='pending' ? 'st-pending' : 'st-active';
      const action = w.status==='pending' ? `<button class="btn btn-primary" onclick="pay('${doc.id}')" style="padding:4px 10px;">Pay</button>` : '<i class="fas fa-check"></i>';
      
      return `<tr><td>${new Date(w.date).toLocaleDateString()}</td><td>${w.shopOwnerEmail}</td><td>${phone||'N/A'}</td><td>${w.amount}</td><td><span class="status-badge ${badge}">${w.status}</span></td><td>${action}</td></tr>`;
    });

    const rows = await Promise.all(promises);
    tbody.innerHTML = rows.join('');
    document.getElementById('pendingCount').textContent = pending;
  }

  window.pay = async (id) => {
    if(confirm("Mark as Paid?")) {
      await db.collection('withdrawals').doc(id).update({ status: 'completed' });
      loadWithdrawals();
    }
  }

  // --- CHART ---
  async function loadChart() {
    const snap = await db.collection('orders').get();
    let data = [0,0,0,0,0,0];
    snap.forEach(d => {
      const m = new Date(d.data().createdAt).getMonth() % 6;
      data[m] += Number(d.data().total);
    });

    const ctx = document.getElementById('salesChart').getContext('2d');
    if(window.salesChart) window.salesChart.destroy();
    window.salesChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Jan','Feb','Mar','Apr','May','Jun'],
        datasets: [{ label: 'Sales (Ksh)', data: data, borderColor: '#7367f0', backgroundColor: 'rgba(115, 103, 240, 0.2)', fill: true }]
      },
      options: { maintainAspectRatio: false }
    });
  }
  </script>
</body>
</html>