<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Time Shop Save â€” Explore</title>

  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%237b2ff7'/><stop offset='1' stop-color='%23ff6ec7'/></linearGradient></defs><rect width='100' height='100' rx='16' fill='url(%23g)'/><text x='50' y='60' font-family='Inter,Arial,sans-serif' font-weight='800' font-size='28' text-anchor='middle' fill='%23070416'>TSS</text></svg>">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700,800&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --bg1:#070416; --accent:#7b2ff7; --text:#eaf3ff; --muted:rgba(234,243,255,0.65);
      --card-bg:rgba(255,255,255,0.03); --card-shadow:0 6px 20px rgba(11,9,26,0.6);
      --accent-grad:linear-gradient(90deg,#7b2ff7,#ff6ec7,#2be7ff);
      --active:#2be72b; --offline:#ff4b4b;
    }
    html,body { height:100%; margin:0; font-family:Inter,system-ui; color:var(--text); background:var(--bg1); }
    * {box-sizing:border-box;} a {color:inherit;text-decoration:none;}

    header { padding:14px 16px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; background:var(--bg1); z-index:10; border-bottom:1px solid rgba(255,255,255,0.05); }
    header h1 { margin:0; font-size:18px; background:var(--accent-grad); -webkit-background-clip:text; color:transparent; }

    .search-bar { display:flex; align-items:center; background:rgba(255,255,255,0.05); padding:8px 12px; border-radius:12px; margin:12px 16px; box-shadow:inset 0 0 8px rgba(255,255,255,0.08); gap:8px; }
    .search-bar input { flex:1; background:transparent; border:none; color:var(--text); font-size:14px; outline:none; }
    .search-bar i { color:var(--muted); font-size:14px; }
    .search-btn { background:var(--accent-grad); border:none; border-radius:8px; color:#071126; font-weight:600; font-size:12px; padding:6px 10px; cursor:pointer; }

    .controls-row { display:flex; gap:10px; align-items:center; padding:0 16px 8px; }
    .loc-btn { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(--muted); cursor:pointer; font-size:13px; }
    .loc-btn.active { color:var(--accent); border-color:var(--g1); }

    .categories { display:flex; overflow-x:auto; padding:12px 16px; gap:12px; scrollbar-width:none; }
    .category { flex:0 0 auto; width:80px; height:80px; background:var(--card-bg); border-radius:16px; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; box-shadow:var(--card-shadow); text-align:center; font-size:12px; transition:all 0.25s; }
    .category:hover { transform:translateY(-4px) scale(1.03); background:var(--accent-grad); color:#071126; }
    .category i { font-size:22px; margin-bottom:6px; color:var(--accent); }

    .shops { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:12px; padding:12px 16px 80px; }
    .shop-card { background:var(--card-bg); border-radius:16px; padding:12px; display:flex; flex-direction:column; align-items:center; position:relative; box-shadow:var(--card-shadow); transition:all 0.3s; cursor:pointer; }
    .shop-card:hover { transform:translateY(-4px); box-shadow:0 8px 30px rgba(0,0,0,0.5); }
    .shop-card img { width:64px; height:64px; border-radius:12px; margin-bottom:8px; object-fit:cover; border:2px solid rgba(255,255,255,0.1); }
    .shop-name { font-size:14px; font-weight:600; margin-bottom:4px; text-align:center; }
    .shop-category { font-size:12px; color:var(--muted); margin-bottom:6px; text-align:center; }
    .status-badge { position:absolute; top:8px; right:8px; padding:3px 7px; border-radius:8px; font-size:10px; color:#071126; font-weight:600; }

    .bottom-nav { position:fixed; bottom:0; width:100%; display:flex; justify-content:space-around; background:rgba(7,4,22,0.9); padding:8px 0; border-top:1px solid rgba(255,255,255,0.05); backdrop-filter:blur(10px); z-index:15; }
    .bottom-nav a { display:flex; flex-direction:column; align-items:center; font-size:12px; color:var(--muted); }
    .bottom-nav a.active { color:var(--accent); font-weight:600; }
    .bottom-nav i { font-size:18px; margin-bottom:2px; }
  </style>
</head>
<body>

<header><h1>Explore Shops</h1></header>

<div class="search-bar">
  <i class="fas fa-search"></i>
  <input type="text" id="searchInput" placeholder="Search shops..." />
  <button class="search-btn" id="searchBtn">Search</button>
</div>

<div class="controls-row">
  <button id="useLocationBtn" class="loc-btn">Use my location</button>
  <div style="flex:1"></div>
  <div id="locationStatus" style="color:var(--muted);font-size:13px"></div>
</div>

<div class="categories" id="categories"></div>
<div class="shops" id="shopContainer">
  <div style="text-align:center;color:var(--muted);grid-column:1/-1;">Loading shops from cloud...</div>
</div>

<div class="bottom-nav">
  <a href="index.html"><i class="fas fa-home"></i>Home</a>
  <a href="explore.html" class="active"><i class="fas fa-compass"></i>Explore</a>
  <a href="orders.html"><i class="fas fa-box-open"></i>Orders</a>
  <a href="profile.html"><i class="fas fa-user"></i>Profile</a>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyCws2eOt3muKCpjHIxB3vUlOHGA06xLhtc",
  authDomain: "time-shop-save.firebaseapp.com",
  projectId: "time-shop-save",
  storageBucket: "time-shop-save.firebasestorage.app",
  messagingSenderId: "1037284454386",
  appId: "1:1037284454386:web:a863e690cc63049e1cc56b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Categories
const categoriesData = [
  {name:'All', icon:'fas fa-globe'}, {name:'Shop', icon:'fas fa-store'},
  {name:'Supermarket', icon:'fas fa-shopping-basket'}, {name:'Grocery', icon:'fas fa-apple-alt'},
  {name:'Electronics', icon:'fas fa-tv'}, {name:'Fashion', icon:'fas fa-tshirt'},
  {name:'Pharmacy', icon:'fas fa-pills'}, {name:'Bakery', icon:'fas fa-bread-slice'},
  {name:'Restaurants', icon:'fas fa-utensils'}, {name:'Beauty', icon:'fas fa-magic'},
  {name:'Sports', icon:'fas fa-football-ball'}, {name:'Books', icon:'fas fa-book'},
  {name:'Hardware', icon:'fas fa-tools'}, {name:'Gifts', icon:'fas fa-gift'},
  {name:'Mobile', icon:'fas fa-mobile-alt'}, {name:'Food', icon:'fas fa-hamburger'},
  {name:'Barbershop', icon:'fas fa-cut'}, {name:'Salon', icon:'fas fa-spa'},
  {name:'Butchery', icon:'fas fa-drumstick-bite'}, {name:'Other', icon:'fas fa-ellipsis-h'}
];

const categoriesContainer = document.getElementById('categories');
categoriesData.forEach(cat => {
  const div = document.createElement('div');
  div.className = 'category';
  div.innerHTML = `<i class="${cat.icon}"></i><span>${cat.name}</span>`;
  div.addEventListener('click', () => renderShops(cat.name));
  categoriesContainer.appendChild(div);
});

const shopContainer = document.getElementById('shopContainer');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');

let allShops = []; // Cache cloud shops here

// 1. FETCH SHOPS FROM FIREBASE
async function loadShops() {
  try {
    // Try 'shopkeepers' collection first
    let snapshot = await db.collection("shopkeepers").get();
    
    // If empty (maybe registered via general users flow), check 'users'
    if (snapshot.empty) {
      snapshot = await db.collection("users").where("role", "==", "shop").get();
    }

    allShops = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      allShops.push({
        name: data.shopName || data.name || "Unknown Shop",
        category: data.category || "Other",
        // Fallback placeholder if no logo
        logo: data.logo || "https://via.placeholder.com/64?text=Shop",
        status: "Active", // Assuming all cloud shops are active for now
        ownerEmail: data.email
      });
    });

    renderShops("All"); // Initial Render

  } catch(e) {
    console.error("Error loading shops:", e);
    shopContainer.innerHTML = `<div style="text-align:center;color:red;grid-column:1/-1;">Error loading shops.<br>${e.message}</div>`;
  }
}

// 2. RENDER LOGIC
function renderShops(filter='All', searchTerm='') {
  shopContainer.innerHTML = '';
  
  let filtered = allShops;

  // Filter by Category
  if(filter && filter !== 'All'){
    filtered = filtered.filter(s => (s.category || '').toLowerCase() === filter.toLowerCase());
  }

  // Filter by Search
  if(searchTerm){
    const q = searchTerm.toLowerCase();
    filtered = filtered.filter(s => (s.name.toLowerCase().includes(q) || s.category.toLowerCase().includes(q)));
  }

  if(!filtered.length){
    shopContainer.innerHTML = `<p style="text-align:center;opacity:0.6;grid-column:1/-1;">No shops found.</p>`;
    return;
  }

  filtered.forEach(shop => {
    const div = document.createElement('div');
    div.className = 'shop-card';
    div.innerHTML = `
      <img src="${shop.logo}" alt="${shop.name}">
      <div class="shop-name">${shop.name}</div>
      <div class="shop-category">${shop.category}</div>
      <div class="status-badge" style="background:var(--active)">Active</div>
    `;
    
    // Click to open shop
    div.addEventListener('click', () => {
      // Save basic info for the next page to use while loading
      localStorage.setItem('currentShop', JSON.stringify({shopName: shop.name}));
      window.location.href = `shop.html?shop=${encodeURIComponent(shop.name)}`;
    });

    shopContainer.appendChild(div);
  });
}

// Event Listeners
searchBtn.addEventListener('click', () => renderShops('All', searchInput.value.trim()));
searchInput.addEventListener('keypress', e => { if(e.key === 'Enter') renderShops('All', searchInput.value.trim()); });

// Start
loadShops();

</script>
</body>
</html>