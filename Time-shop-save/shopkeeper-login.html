<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shopkeeper Login — Time Shop Save</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%237b2ff7'/><stop offset='1' stop-color='%23ff6ec7'/></linearGradient></defs><rect width='100' height='100' rx='16' fill='url(%23g)'/><text x='50' y='60' font-family='Inter,Arial,sans-serif' font-weight='800' font-size='36' text-anchor='middle' fill='%23070416'>TSS</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg1:#070416;--g1:#7b2ff7;--g2:#ff6ec7;--g3:#2be7ff;--text:#eaf3ff;--muted:rgba(234,243,255,0.65);--accent:linear-gradient(90deg,var(--g1),var(--g2),var(--g3));}
*{box-sizing:border-box}body{margin:0;font-family:'Inter',sans-serif;background:var(--bg1);color:var(--text);display:flex;justify-content:center;align-items:center;height:100vh}
.bg{position:absolute;inset:0;background:radial-gradient(600px 300px at 10% 20%,rgba(123,47,247,0.12),transparent),radial-gradient(500px 240px at 90% 80%,rgba(43,231,255,0.08),transparent),linear-gradient(180deg,#05020b 0%,#0b0630 50%,#07132a 100%);z-index:-1}
.card{width:92%;max-width:440px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:24px 26px;box-shadow:0 8px 30px rgba(0,0,0,0.5);backdrop-filter:blur(10px);position:relative}
.card h2{text-align:center;font-size:20px;margin-bottom:14px;background:var(--accent);-webkit-background-clip:text;color:transparent}
form{display:flex;flex-direction:column;gap:10px}input{padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.05);color:var(--text);font-size:14px}input:focus{outline:none;border-color:var(--g2)}
button{background:var(--accent);color:#071126;font-weight:700;padding:12px;border:0;border-radius:10px;cursor:pointer}button:hover{opacity:0.95}
.switch{text-align:center;font-size:13px;color:var(--muted)}.switch a{color:var(--g3);cursor:pointer}.hidden{display:none!important}
.back-btn{position:absolute;top:12px;left:12px;background:rgba(255,255,255,0.05);border:none;color:var(--text);border-radius:50%;width:36px;height:36px;font-size:18px;cursor:pointer}.back-btn:hover{background:rgba(255,255,255,0.1)}
.error{text-align:center;color:#ff4d4d;font-size:13px;margin-top:4px}
</style>
</head>
<body>
<div class="bg"></div>

<div class="card">
  <button class="back-btn" onclick="window.location.href='index.html'" title="Back">←</button>
  <h2 id="formTitle">Shopkeeper Login</h2>

  <form id="loginForm" autocomplete="off">
    <input id="loginEmail" type="email" placeholder="Email" required>
    <input id="loginPassword" type="password" placeholder="Password" required>
    <button type="submit" id="loginBtn">Login</button>
    <div id="loginMsg" class="error hidden"></div>
    <div class="switch">Don’t have an account? <a href="shopkeeper-registration.html">Register</a></div>
  </form>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCws2eOt3muKCpjHIxB3vUlOHGA06xLhtc",
  authDomain: "time-shop-save.firebaseapp.com",
  projectId: "time-shop-save",
  storageBucket: "time-shop-save.firebasestorage.app",
  messagingSenderId: "1037284454386",
  appId: "1:1037284454386:web:a863e690cc63049e1cc56b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginForm = document.getElementById("loginForm");
const loginMsg = document.getElementById("loginMsg");
const loginBtn = document.getElementById("loginBtn");

function showError(msg) {
  loginMsg.textContent = msg;
  loginMsg.classList.remove("hidden");
}

loginForm.addEventListener("submit", async e => {
  e.preventDefault();
  loginMsg.classList.add("hidden");
  
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value;

  loginBtn.textContent = "Logging in...";
  loginBtn.disabled = true;

  try {
    // 1. Sign in with Firebase
    const cred = await auth.signInWithEmailAndPassword(email, password);
    
    // 2. Check if user profile exists in 'shopkeepers' or 'users'
    let doc = await db.collection("shopkeepers").doc(cred.user.uid).get();
    if (!doc.exists) doc = await db.collection("users").doc(cred.user.uid).get();

    if (doc.exists) {
      // 3. Save user data to LocalStorage for the dashboard to use immediately
      const userData = doc.data();
      localStorage.setItem("user:" + email, JSON.stringify(userData));
      localStorage.setItem("rememberUser", email);
      
      // 4. Redirect
      window.location.href = "shopkeeper.html";
    } else {
      showError("Profile not found. Please register.");
      auth.signOut();
    }
  } catch (err) {
    console.error(err);
    if (err.code === "auth/invalid-credential" || err.code === "auth/user-not-found" || err.code === "auth/wrong-password") {
      showError("Invalid email or password.");
    } else {
      showError("Login failed: " + err.message);
    }
  }
  loginBtn.textContent = "Login";
  loginBtn.disabled = false;
});
</script>
</body>
</html>