<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orders â€” Time Shop Save</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700,800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    /* Your Exact Styling */
    :root { --bg1:#070416; --accent:#7b2ff7; --text:#eaf3ff; --muted:rgba(234,243,255,0.7); --card-bg:rgba(255,255,255,0.04); --accent-grad:linear-gradient(90deg,#7b2ff7,#ff6ec7,#2be7ff); --active:#2be72b; --offline:#ff4b4b; }
    body { margin:0; font-family:Inter,system-ui; color:var(--text); background:var(--bg1); overflow-y:auto; }
    header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,0.1); background:rgba(7,4,22,0.9); position:sticky; top:0; z-index:10; }
    header h1 { margin:0; font-size:18px; background:var(--accent-grad); -webkit-background-clip:text; color:transparent; font-weight:700; }
    .back-btn { display:flex; align-items:center; gap:6px; font-size:15px; color:var(--muted); background:none; border:none; cursor:pointer; transition:all 0.3s; }
    .back-btn:hover { color:var(--accent); transform:translateX(-3px); }
    .order-container { padding:16px; padding-bottom:110px; }
    .order-item { background:var(--card-bg); border-radius:16px; padding:10px; display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .order-item img { width:70px; height:70px; border-radius:12px; object-fit:cover; }
    .item-info { flex:1; }
    .item-info h3 { margin:0; font-size:14px; font-weight:600; }
    .item-info p { margin:4px 0; color:var(--accent); font-weight:700; font-size:13px; }
    .remove-btn { background:#ff4b4b; border:none; border-radius:8px; color:#fff; font-size:12px; padding:6px 10px; cursor:pointer; }
    .total { text-align:right; font-size:15px; font-weight:700; color:var(--accent); margin-top:20px; }
    .wallet { background:var(--card-bg); border-radius:16px; padding:14px; margin:20px 16px 90px 16px; }
    .wallet h2 { font-size:16px; margin:0 0 10px 0; }
    .wallet-balance { font-size:15px; font-weight:700; color:var(--active); }
    .wallet-actions { display:flex; gap:10px; margin-top:10px; }
    .wallet-actions button { flex:1; border:none; border-radius:8px; padding:10px; font-weight:600; cursor:pointer; color:#fff; }
    .add-funds { background:var(--accent-grad); color:#071126; }
    .pay-now { background:var(--active); color:#071126; }
    .message { text-align:center; background:var(--card-bg); border-radius:16px; padding:20px; margin:20px 16px; display:none; font-weight:600; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:100; box-shadow:0 10px 40px rgba(0,0,0,0.8); width:80%; max-width:300px; }
    .bottom-nav { position:fixed; bottom:0; width:100%; display:flex; justify-content:space-around; background:rgba(7,4,22,0.9); padding:8px 0; border-top:1px solid rgba(255,255,255,0.05); backdrop-filter:blur(10px); z-index:15; }
    .bottom-nav a { display:flex; flex-direction:column; align-items:center; font-size:12px; color:var(--muted); text-decoration:none; }
    .bottom-nav a.active { color:var(--accent); }
    .bottom-nav i { font-size:18px; margin-bottom:2px; }
  </style>
</head>
<body>

<header>
  <button class="back-btn" onclick="history.back()">Back</button>
  <h1>Orders</h1>
  <span></span>
</header>

<div class="order-container" id="orderContainer"></div>

<div class="wallet">
  <h2>Wallet (Cloud)</h2>
  <div class="wallet-balance">Balance: Ksh <span id="balance">0.00</span></div>
  <div class="wallet-actions">
    <button class="add-funds" onclick="addFunds()">Add Funds</button>
    <button class="pay-now" id="payNowBtn" onclick="payNow()">Pay Now</button>
  </div>
</div>

<div class="message" id="messageBox"></div>

<div class="bottom-nav">
  <a href="index.html">Home</a>
  <a href="explore.html">Explore</a>
  <a href="orders.html" class="active">Orders</a>
  <a href="profile.html">Profile</a>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// --- 1. FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyCws2eOt3muKCpjHIxB3vUlOHGA06xLhtc",
  authDomain: "time-shop-save.firebaseapp.com",
  projectId: "time-shop-save",
  storageBucket: "time-shop-save.firebasestorage.app",
  messagingSenderId: "1037284454386",
  appId: "1:1037284454386:web:a863e690cc63049e1cc56b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- 2. CONFIG & STATE ---
const MPESA_ENDPOINT = "https://mpesa-stk.giftedtech.co.ke/api/payMaka.php";
const VERIFY_ENDPOINT = "https://mpesa-stk.giftedtech.co.ke/api/verify-transaction.php";

const params = new URLSearchParams(window.location.search);
let shopName = decodeURIComponent(params.get('shop') || '');
if (!shopName) {
  // Fallback to localstorage if URL param missing
  const stored = localStorage.getItem('currentShop');
  if (stored) {
    try { shopName = JSON.parse(stored).shopName || JSON.parse(stored); } 
    catch(e) { shopName = stored; }
  }
}

const cartKey = 'cart_' + (shopName || 'unknown');
let cart = JSON.parse(localStorage.getItem(cartKey) || '[]');
let currentUser = null;
let currentBalance = 0; // Tracks Cloud Balance locally

const container = document.getElementById("orderContainer");
const balanceElem = document.getElementById("balance");
const messageBox = document.getElementById("messageBox");

// --- 3. AUTH & WALLET SYNC ---
auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUser = user;
    // Real-time listener for Wallet Balance
    db.collection("users").doc(user.uid).onSnapshot((doc) => {
      if (doc.exists) {
        currentBalance = Number(doc.data().balance || 0);
        balanceElem.textContent = currentBalance.toLocaleString();
      } else {
        // Create doc if missing
        db.collection("users").doc(user.uid).set({ email: user.email, balance: 0 }, { merge: true });
      }
    });
  } else {
    // If not logged in, check local fallback or redirect
    const localUser = localStorage.getItem('rememberUser');
    if (!localUser) {
        alert("Please login first.");
        window.location.href = "customer-login.html";
    }
  }
});

// --- 4. CART LOGIC ---
function renderCart(){
  if(cart.length === 0){
    container.innerHTML = `<p style="text-align:center;margin-top:40px;">ðŸ›’ No items in your order.</p>`;
    return;
  }
  container.innerHTML = cart.map((item,i)=>`
    <div class="order-item">
      <img src="${item.img || 'https://via.placeholder.com/70'}" alt="${item.name}">
      <div class="item-info">
        <h3>${item.name}</h3>
        <p>Ksh ${item.price} Ã— ${item.qty} = <b>Ksh ${(item.price * item.qty).toFixed(2)}</b></p>
      </div>
      <button class="remove-btn" onclick="removeItem(${i})">Remove</button>
    </div>
  `).join('') + `<div class="total">Total Due: Ksh ${totalCost().toFixed(2)}</div>`;
}

function totalCost(){
  return cart.reduce((sum,item)=> sum + (parseFloat(item.price) * (item.qty || 1)), 0);
}

window.removeItem = function(i){
  cart.splice(i,1);
  localStorage.setItem(cartKey, JSON.stringify(cart));
  renderCart();
}

// --- 5. PAYMENT & WALLET LOGIC ---

function showMessage(msg, isError=false){
  messageBox.innerHTML = msg;
  messageBox.style.display = "block";
  messageBox.style.color = isError ? "#ff4b4b" : "var(--active)";
  setTimeout(()=>{messageBox.style.display="none";}, 5000);
}

function formatPhone(phone){
  phone = phone.replace(/\D/g,'');
  if(phone.startsWith('0')) return '254'+phone.substring(1);
  if(phone.startsWith('7')) return '254'+phone;
  if(phone.startsWith('1')) return '254'+phone;
  return phone;
}

// A. Add Funds Flow
window.addFunds = function(){
  if(!currentUser) return alert("Please login to add funds.");
  
  const amount = prompt("Enter amount to add:");
  const amt = parseInt(amount);
  if(isNaN(amt) || amt <= 0) return showMessage("âŒ Invalid amount.", true);
  
  const phone = prompt("Enter Safaricom number (e.g. 0712345678):");
  if(!phone) return;
  
  const formattedPhone = formatPhone(phone);
  
  // Trigger M-Pesa
  stkPush(formattedPhone, amt, async () => {
    // ON SUCCESS: Update Cloud Balance
    const newBal = currentBalance + amt;
    await db.collection("users").doc(currentUser.uid).update({ balance: newBal });
    
    // Record Transaction
    db.collection("transactions").add({
        userId: currentUser.uid,
        type: 'deposit',
        amount: amt,
        method: 'M-Pesa',
        date: new Date().toISOString()
    });
    
    showMessage(`âœ… Ksh ${amt} added successfully!`);
  });
}

// B. M-Pesa API Call
async function stkPush(phone, amount, onSuccess){
  try {
    showMessage("ðŸ“² Sending STK push to phone...");
    const res = await axios.post(MPESA_ENDPOINT, { phoneNumber: phone, amount });
    
    if(res.data.success && res.data.CheckoutRequestID){
      showMessage("âœ… STK Sent! Enter PIN on your phone.");
      await pollTransaction(res.data.CheckoutRequestID, onSuccess);
    } else {
      showMessage("âš ï¸ STK Failed. Try again.", true);
    }
  } catch (err) {
    showMessage("âŒ Connection Error.", true);
    console.error(err);
  }
}

// C. Verify Transaction
async function pollTransaction(checkoutId, onSuccess){
  let tries = 0;
  const interval = setInterval(async ()=>{
    tries++;
    try {
      const res = await axios.post(VERIFY_ENDPOINT, { checkoutRequestId: checkoutId });
      const data = res.data;
      if(data.status === 'completed'){
        clearInterval(interval);
        if(onSuccess) onSuccess();
      } else if(data.status === 'failed'){
        clearInterval(interval);
        showMessage("âŒ Payment Failed/Cancelled.", true);
      }
    } catch(e){ console.error(e); }
    
    // Stop after 60 seconds
    if(tries > 60) { clearInterval(interval); showMessage("â³ Timeout. Please try again.", true); }
  }, 2000); // Check every 2 seconds
}

// D. Pay Now Flow
window.payNow = async function(){
  if(cart.length === 0) return showMessage("Cart is empty.", true);
  if(!currentUser) return alert("Please login first.");

  const total = totalCost();
  
  // 1. Check Balance
  if(currentBalance >= total){
    processOrder(total);
  } else {
    // 2. Insufficient Funds -> Prompt M-Pesa
    const deficit = total - currentBalance;
    const phone = prompt(`Balance: Ksh ${currentBalance}. You need Ksh ${deficit} more.\nEnter M-Pesa number:`);
    if(!phone) return;
    
    const formattedPhone = formatPhone(phone);
    stkPush(formattedPhone, deficit, async () => {
      // Update balance first
      const newBal = currentBalance + deficit;
      await db.collection("users").doc(currentUser.uid).update({ balance: newBal });
      // Then process
      processOrder(total);
    });
  }
}

// E. Finalize Order (Cloud Save)
async function processOrder(total){
  const btn = document.getElementById('payNowBtn');
  btn.textContent = "Processing...";
  btn.disabled = true;

  try {
    // 1. Deduct Balance
    const newBal = currentBalance - total;
    await db.collection("users").doc(currentUser.uid).update({ balance: newBal });

    // 2. Identify Shopkeeper
    const shopOwnerEmail = cart[0].ownerEmail; // Ensure products have this saved
    if(!shopOwnerEmail) throw new Error("Shop owner not identified in products.");

    // 3. Save Order to Cloud
    const pickupCode = Math.floor(Math.random()*900000+100000);
    await db.collection("orders").add({
      customerEmail: currentUser.email,
      shopOwnerEmail: shopOwnerEmail,
      shopName: shopName,
      items: cart,
      total: total,
      status: "Paid",
      pickupCode: pickupCode,
      createdAt: new Date().toISOString()
    });

    // 4. Cleanup
    localStorage.removeItem(cartKey);
    cart = [];
    renderCart();
    
    document.getElementById('orderContainer').innerHTML = 
        `<div style='text-align:center;padding:40px'>
            <i class="fas fa-check-circle" style="font-size:50px;color:var(--active)"></i><br><br>
            <h3>Order Successful!</h3>
            <p>Pickup Code: <b style="color:var(--active);font-size:20px">${pickupCode}</b></p>
            <p style="color:var(--muted)">Show this code to the shopkeeper.</p>
        </div>`;
    
    document.getElementById('balance').textContent = newBal.toLocaleString();

  } catch(e) {
    showMessage("Order Error: " + e.message, true);
    btn.textContent = "Pay Now";
    btn.disabled = false;
  }
}

// Init
renderCart();
</script>
</body>
</html>