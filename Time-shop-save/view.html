<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>View Shop ‚Äî Time Shop Save</title>

  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%237b2ff7'/><stop offset='1' stop-color='%23ff6ec7'/></linearGradient></defs><rect width='100' height='100' rx='16' fill='url(%23g)'/><text x='50' y='60' font-family='Inter,Arial,sans-serif' font-weight='800' font-size='28' text-anchor='middle' fill='%23070416'>TSS</text></svg>">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700,800&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* Keeps your exact existing styling */
    :root {
      --bg1:#070416; --accent:#7b2ff7; --text:#eaf3ff; --muted:rgba(234,243,255,0.7);
      --card-bg:rgba(255,255,255,0.04); --accent-grad:linear-gradient(90deg,#7b2ff7,#ff6ec7,#2be7ff);
      --active:#2be72b; --offline:#ff4b4b;
    }
    body { margin:0; font-family:Inter,system-ui; color:var(--text); background:var(--bg1); overflow-y:auto; }
    header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,0.1); background:rgba(7,4,22,0.9); position:sticky; top:0; z-index:10; }
    header h1 { margin:0; font-size:18px; background:var(--accent-grad); -webkit-background-clip:text; color:transparent; font-weight:700; }
    .back-btn { display:flex; align-items:center; gap:6px; font-size:15px; color:var(--muted); background:none; border:none; cursor:pointer; transition:all 0.3s; }
    .back-btn:hover { color:var(--accent); transform:translateX(-3px); }
    .notice { text-align:center; background:var(--card-bg); padding:10px; color:var(--accent); font-weight:600; border-bottom:1px solid rgba(255,255,255,0.1); }
    .shop-info { padding:16px; text-align:center; }
    .shop-info h2 { margin:0; font-size:20px; font-weight:700; background:var(--accent-grad); -webkit-background-clip:text; color:transparent; }
    .shop-info p { margin:8px 0; color:var(--muted); }
    .status { display:inline-flex; align-items:center; gap:6px; margin-top:8px; font-weight:600; color:var(--muted); }
    .dot { width:10px; height:10px; border-radius:50%; }
    .product-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:12px; padding:16px; padding-bottom:100px; }
    .product-card { background:var(--card-bg); border-radius:16px; overflow:hidden; transition:transform 0.3s; position:relative; }
    .product-card:hover { transform:translateY(-3px); }
    .product-card img { width:100%; height:130px; object-fit:cover; }
    .product-details { padding:10px; }
    .product-details h3 { margin:0; font-size:14px; font-weight:600; color:var(--text); display:flex; align-items:center; gap:8px; justify-content:space-between; }
    .product-details p { margin:4px 0; color:var(--accent); font-weight:700; font-size:13px; }
    .status-notice { text-align:center; background:var(--card-bg); border-radius:12px; padding:10px; margin:10px auto; max-width:320px; display:none; font-weight:600; color:var(--text); }
    .bottom-nav { position:fixed; bottom:0; width:100%; display:flex; justify-content:space-around; background:rgba(7,4,22,0.9); padding:8px 0; border-top:1px solid rgba(255,255,255,0.05); backdrop-filter:blur(10px); }
    .bottom-nav a { display:flex; flex-direction:column; align-items:center; font-size:12px; color:var(--muted); }
    .bottom-nav a.active { color:var(--accent); }
    .bottom-nav i { font-size:18px; margin-bottom:2px; }
    .sold-tag { font-weight:800; color:var(--offline); margin-left:6px; font-size:12px; }
  </style>
</head>
<body>

<header>
  <button class="back-btn" id="backBtn"><i class="fas fa-arrow-left"></i> Back</button>
  <h1>View Shop</h1>
  <span></span>
</header>

<div class="notice">üëÅÔ∏è You‚Äôre viewing your shop as customers see it</div>

<div class="shop-info">
  <h2 id="shopName">Loading...</h2>
  <p id="shopDesc">Fetching details...</p>
  <div class="status">
    <div class="dot" id="statusDot" style="background:var(--muted)"></div>
    <span id="statusText">Checking...</span>
  </div>
</div>

<div id="statusNotice" class="status-notice"></div>

<div class="product-grid" id="productGrid" aria-live="polite">
  <div style="grid-column:1/-1;text-align:center;color:var(--muted)">Connecting to cloud...</div>
</div>

<div class="bottom-nav">
  <a href="index.html"><i class="fas fa-home"></i>Home</a>
  <a href="view.html" class="active"><i class="fas fa-store"></i>View</a>
  <a href="shopkeeper.html"><i class="fas fa-user-cog"></i>Shopkeeper</a>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCws2eOt3muKCpjHIxB3vUlOHGA06xLhtc",
  authDomain: "time-shop-save.firebaseapp.com",
  projectId: "time-shop-save",
  storageBucket: "time-shop-save.firebasestorage.app",
  messagingSenderId: "1037284454386",
  appId: "1:1037284454386:web:a863e690cc63049e1cc56b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

auth.onAuthStateChanged(async (user) => {
  if (user) {
    let doc = await db.collection("shopkeepers").doc(user.uid).get();
    if(!doc.exists) doc = await db.collection("users").doc(user.uid).get();

    if(doc.exists){
      const data = doc.data();
      const shopName = data.shopName || data.name || "My Shop";
      
      document.getElementById('shopName').textContent = shopName;
      document.getElementById('shopDesc').textContent = data.category || "General Store";
      
      const dot = document.getElementById('statusDot');
      const txt = document.getElementById('statusText');
      const notice = document.getElementById('statusNotice');
      
      dot.style.background = 'var(--active)';
      txt.textContent = 'Active';
      txt.style.color = 'var(--active)';
      notice.style.display = 'block';
      notice.style.background = 'rgba(43,231,43,0.08)';
      notice.style.color = 'var(--active)';
      notice.textContent = 'üü¢ This is a live preview of your cloud data.';

      loadCloudProducts(user.email);
    }
  } else {
    window.location.href = 'shopkeeper-login.html';
  }
});

async function loadCloudProducts(ownerEmail) {
  const grid = document.getElementById('productGrid');
  try {
    const q = db.collection("products").where("ownerEmail", "==", ownerEmail);
    const snapshot = await q.get();

    grid.innerHTML = '';
    if(snapshot.empty){
      grid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:var(--muted);">No products found in cloud database.<br>Go to Dashboard to add some.</p>`;
      return;
    }

    snapshot.forEach(doc => {
      const p = doc.data();
      const soldText = (Number(p.stock || 0) <= 0) ? `<span class="sold-tag">SOLD OUT</span>` : '';
      const div = document.createElement('div');
      div.className = 'product-card';
      div.innerHTML = `
        <img src="${escapeHtml(p.img || 'https://via.placeholder.com/150')}" alt="${escapeHtml(p.name)}">
        <div class="product-details">
          <h3>${escapeHtml(p.name)} ${soldText}</h3>
          <p>Ksh ${Number(p.price).toFixed(2)}</p>
        </div>
      `;
      grid.appendChild(div);
    });
  } catch(e) {
    console.error(e);
    grid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:red;">Error loading products: ${e.message}</p>`;
  }
}

document.getElementById('backBtn').addEventListener('click', ()=> window.location.href = 'shopkeeper.html');
</script>
</body>
</html>