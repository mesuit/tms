<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Profile â€” Time Shop Save</title>

<link rel="icon" type="image/svg+xml"
      href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%237b2ff7'/><stop offset='1' stop-color='%23ff6ec7'/></linearGradient></defs><rect width='100' height='100' rx='16' fill='url(%23g)'/><text x='50' y='60' font-family='Inter,Arial,sans-serif' font-weight='800' font-size='28' text-anchor='middle' fill='%23070416'>TSS</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700,800&display=swap" rel="stylesheet">
<script src="https://kit.fontawesome.com/a2d9b9f0d4.js" crossorigin="anonymous"></script>
<style>
  :root{
    --bg1:#070416; --card-bg: rgba(255,255,255,0.03); --muted:rgba(234,243,255,0.65);
    --accent-grad: linear-gradient(90deg,#7b2ff7,#ff6ec7,#2be7ff); --text:#eaf3ff; --active:#2be72b; --danger:#ff4b4b; --width-max:1200px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui;background:var(--bg1);color:var(--text)}
  .wrap{max-width:var(--width-max);margin:18px auto;padding:18px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{margin:0;background:var(--accent-grad);-webkit-background-clip:text;color:transparent}
  .layout{display:grid;grid-template-columns:220px 1fr;gap:14px}
  @media(max-width:900px){ .layout{grid-template-columns:1fr} }
  .card{background:var(--card-bg);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .sidebar .menu{display:flex;flex-direction:column;gap:6px;margin-top:12px}
  .menu button{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;border:0;background:transparent;color:var(--muted);cursor:pointer;text-align:left}
  .menu button.active{background:linear-gradient(90deg,rgba(123,47,247,0.12),rgba(43,231,255,0.04));color:var(--text)}
  .avatar{width:92px;height:92px;border-radius:14px;overflow:hidden;border:2px solid rgba(255,255,255,0.06);background:#071126}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .btn{padding:8px 10px;border-radius:8px;border:0;background:var(--accent-grad);color:#071126;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  input,select,textarea{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);width:100%}
  .small{font-size:13px;color:var(--muted)}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:800px){ .form-grid{grid-template-columns:1fr} }
  .tx-list,.orders-list{max-height:46vh;overflow:auto;padding-right:6px;margin-top:8px}
  label.small { display:block; margin-bottom:6px; color:var(--muted); font-size:13px; }
  .footer-note{margin-top:12px;color:var(--muted);font-size:13px}
  .bottom-nav{ position:fixed; bottom:0; width:100%; display:flex; justify-content:space-around; background:rgba(7,4,22,0.9); padding:8px 0; border-top:1px solid rgba(255,255,255,0.05); backdrop-filter:blur(10px); z-index:15; }
  .bottom-nav a{ display:flex; flex-direction:column; align-items:center; font-size:12px; color:var(--muted); text-decoration:none; }
  .bottom-nav a.active{ color:var(--accent-grad); font-weight:600; }
  .bottom-nav i{ font-size:18px; margin-bottom:2px; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Customer Profile</h1>
  </header>

  <div class="layout">
    <aside class="card sidebar">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="avatar" id="avatarWrap"><img id="avatarImg" src="https://via.placeholder.com/92?text=You" alt="avatar"></div>
        <div>
          <div id="uName" style="font-weight:800">User</div>
          <div class="small" id="uEmail">you@example.com</div>
        </div>
      </div>

      <div class="menu" role="navigation" aria-label="Profile menu">
        <button id="menuProfile" class="active">Profile Settings</button>
        <button id="menuWallet">Wallet & Top-up</button>
        <button id="menuOrders">Orders</button>
        <button id="menuSecurity">Security</button>
      </div>

      <div style="margin-top:14px">
        <div class="small">Quick actions</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn ghost" id="profileExportBtn">Export Profile</button>
          <button class="btn ghost" id="logoutBtn" style="color:#ff4b4b;border-color:#ff4b4b">Logout</button>
        </div>
      </div>
    </aside>

    <main>
      <div class="card" id="mainCard">
        <section id="profileSection">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800;font-size:18px">Profile Settings</div>
              <div class="small">Update personal details</div>
            </div>
            <div><button class="btn" id="saveProfileBtnTop">Save changes</button></div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

          <div class="form-grid">
            <div>
              <label class="small">Full Name</label>
              <input id="fullName" placeholder="Full name">
            </div>
            <div>
              <label class="small">Phone</label>
              <input id="phoneField" placeholder="07..." >
            </div>
            <div>
              <label class="small">Email</label>
              <input id="emailField" placeholder="email@example.com" disabled>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" id="saveProfileBtn">Save Changes</button>
          </div>
        </section>

        <section id="walletSection" style="display:none; margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800;font-size:18px">Wallet & Top-up</div>
              <div class="small">Your balance and top-up options</div>
            </div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

          <div style="display:flex;gap:12px;align-items:center">
            <div>
              <div class="small">Balance (Cloud)</div>
              <div style="font-weight:800;font-size:20px" id="balanceDisplay">Ksh 0.00</div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
             <div class="small" style="color:var(--muted)">Top-up functionality coming soon.</div>
          </div>
        </section>

        <section id="ordersSection" style="display:none; margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800;font-size:18px">Orders</div>
              <div class="small">Your recent cloud orders</div>
            </div>
            <div><button class="btn ghost" id="refreshOrdersBtn">Refresh</button></div>
          </div>

          <div id="ordersList" class="orders-list">
             <div class="small" style="text-align:center;padding:20px">Loading orders...</div>
          </div>
        </section>

        <section id="securitySection" style="display:none; margin-top:12px">
          <div style="font-weight:800">Security</div>
          <div class="small" style="margin-top:8px">To change your password, please use the reset link on the login page or contact support.</div>
        </section>
      </div>
    </main>
  </div>
</div>

<div class="bottom-nav" aria-hidden="false">
  <a href="index.html"><i class="fas fa-home"></i>Home</a>
  <a href="explore.html"><i class="fas fa-compass"></i>Explore</a>
  <a href="orders.html"><i class="fas fa-box-open"></i>Orders</a>
  <a href="profile.html" class="active"><i class="fas fa-user"></i>Profile</a>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyCws2eOt3muKCpjHIxB3vUlOHGA06xLhtc",
  authDomain: "time-shop-save.firebaseapp.com",
  projectId: "time-shop-save",
  storageBucket: "time-shop-save.firebasestorage.app",
  messagingSenderId: "1037284454386",
  appId: "1:1037284454386:web:a863e690cc63049e1cc56b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;

// Auth Check
auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUser = user;
    el('uEmail').textContent = user.email;
    
    // Load Profile Data
    try {
        let doc = await db.collection("users").doc(user.uid).get();
        if(!doc.exists) doc = await db.collection("shopkeepers").doc(user.uid).get();
        
        if(doc.exists){
            const data = doc.data();
            el('uName').textContent = data.name || "User";
            el('fullName').value = data.name || "";
            el('phoneField').value = data.phone || "";
            el('emailField').value = user.email;
        }
    } catch(e) {
        console.error("Error loading profile", e);
    }

    // Load Orders
    loadOrders();

  } else {
    window.location.href = 'customer-login.html';
  }
});

function el(id){ return document.getElementById(id); }

// --- ORDERS ---
async function loadOrders() {
  if (!currentUser) return;
  
  const list = el('ordersList');
  list.innerHTML = '<div class="small" style="text-align:center;padding:20px">Loading...</div>';

  try {
    const q = db.collection("orders").where("customerEmail", "==", currentUser.email);
    const snapshot = await q.get();

    list.innerHTML = '';
    if(snapshot.empty){
        list.innerHTML = '<div class="small" style="text-align:center;padding:20px">No orders found.</div>';
        return;
    }

    snapshot.forEach(doc => {
        const o = doc.data();
        const div = document.createElement('div');
        div.style.padding = '10px';
        div.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
        div.innerHTML = `
            <div style="display:flex;justify-content:space-between">
                <strong>${o.shopName}</strong>
                <span>Ksh ${o.total}</span>
            </div>
            <div class="small" style="color:var(--muted)">${new Date(o.createdAt).toLocaleDateString()} - ${o.status}</div>
            <div class="small" style="margin-top:5px">${(o.items || []).map(i => i.name + ' x' + i.qty).join(', ')}</div>
        `;
        list.appendChild(div);
    });

  } catch(e) {
    console.error(e);
    list.innerHTML = '<div class="small" style="text-align:center;color:red">Error loading orders.</div>';
  }
}

el('refreshOrdersBtn').addEventListener('click', loadOrders);

// --- SAVE PROFILE ---
async function saveProfile() {
    if(!currentUser) return;
    const newName = el('fullName').value;
    const newPhone = el('phoneField').value;
    const btn = el('saveProfileBtn');
    
    btn.textContent = "Saving...";
    try {
        await db.collection("users").doc(currentUser.uid).update({
            name: newName,
            phone: newPhone
        });
        alert("Profile updated!");
    } catch(e) {
        // If doc doesn't exist, try setting it
        try {
             await db.collection("users").doc(currentUser.uid).set({
                name: newName,
                phone: newPhone,
                email: currentUser.email,
                role: 'customer' // assume customer if fixing missing doc
            }, { merge: true });
            alert("Profile created/updated!");
        } catch(e2) {
            alert("Error updating profile: " + e2.message);
        }
    }
    btn.textContent = "Save Changes";
}

el('saveProfileBtn').addEventListener('click', saveProfile);
el('saveProfileBtnTop').addEventListener('click', saveProfile);

// --- LOGOUT ---
el('logoutBtn').addEventListener('click', () => {
    auth.signOut().then(() => {
        window.location.href = "customer-login.html";
    });
});

// Menu Switching (Same as before)
el('menuProfile').addEventListener('click', ()=> switchPanel('profile'));
el('menuWallet').addEventListener('click', ()=> switchPanel('wallet'));
el('menuOrders').addEventListener('click', ()=> switchPanel('orders'));
el('menuSecurity').addEventListener('click', ()=> switchPanel('security'));

function switchPanel(p){
  el('profileSection').style.display = p === 'profile' ? '' : 'none';
  el('walletSection').style.display = p === 'wallet' ? '' : 'none';
  el('ordersSection').style.display = p === 'orders' ? '' : 'none';
  el('securitySection').style.display = p === 'security' ? '' : 'none';
  document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
  if(p === 'profile') el('menuProfile').classList.add('active');
  if(p === 'wallet') el('menuWallet').classList.add('active');
  if(p === 'orders') el('menuOrders').classList.add('active');
  if(p === 'security') el('menuSecurity').classList.add('active');
}
</script>
</body>
</html>