<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shopkeeper â€” Time Shop Save</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700,800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --bg1:#070416; --g1:#7b2ff7; --g2:#ff6ec7; --g3:#2be7ff; --text:#eaf3ff; 
    --muted:rgba(234,243,255,0.65); --card-bg:rgba(255,255,255,0.03); 
    --accent-grad: linear-gradient(90deg,var(--g1),var(--g2),var(--g3));
    --card-shadow:0 10px 40px rgba(0,0,0,0.6); --active:#2be72b; --danger:#ff4b4b; 
    --sidebar-w:84px; --panel-w:320px;
  }
  
  *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui;background:var(--bg1);color:var(--text);overflow:hidden}a{color:inherit;text-decoration:none}.app{display:flex;height:100vh}
  aside.sidebar{width:var(--sidebar-w);background:var(--card-bg);box-shadow:var(--card-shadow);border-right:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;align-items:center;padding:14px 8px;gap:12px}
  aside .logo-mark{width:46px;height:46px;border-radius:10px;background:var(--accent-grad);display:flex;align-items:center;justify-content:center;font-weight:800;color:#071126}
  .nav-btn{width:100%;display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px;border-radius:10px;color:var(--muted);cursor:pointer;border:none;background:transparent}
  .nav-btn.active{background:rgba(123,47,247,0.15);color:var(--g3)}
  .nav-btn i{font-size:18px}.nav-label{font-size:11px;text-align:center}
  .main{flex:1;display:flex;flex-direction:column;overflow:auto}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;border-bottom:1px solid rgba(255,255,255,0.04);background:rgba(7,4,22,0.92);position:sticky;top:0;z-index:10}
  .header-left{display:flex;align-items:center;gap:12px}
  .shop-title{font-weight:800}
  .content{padding:18px;display:grid;grid-template-columns:1fr var(--panel-w);gap:18px;align-items:start;height:calc(100vh - 120px)}
  @media (max-width:980px){.content{grid-template-columns:1fr}.sidebar{display:none}}
  .card{background:var(--card-bg);padding:14px;border-radius:12px;box-shadow:var(--card-shadow);border:1px solid rgba(255,255,255,0.03);overflow:auto;margin-bottom: 15px;}
  .kpis{display:flex;gap:12px;margin-bottom:12px}.kpi{flex:1;padding:12px;border-radius:12px;background:rgba(255,255,255,0.05);display:flex;flex-direction:column;gap:6px}
  .panel-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;font-weight: 800; font-size: 18px;}
  .product{background:rgba(255,255,255,0.02);border-radius:10px;padding:10px;position:relative; display:flex; gap:10px; align-items: center; margin-bottom: 8px;}
  .product img{width:60px;height:60px;object-fit:cover;border-radius:8px}
  
  /* VISIBLE BUTTONS */
  .btn { padding: 10px 14px; border-radius: 8px; border: 0; background: var(--accent-grad); color: #071126; font-weight: 800; cursor: pointer; transition: transform 0.2s; }
  .btn:hover { opacity: 0.9; transform: translateY(-1px); }
  .btn.ghost{background:transparent; border:2px solid var(--g3); color:var(--g3); font-weight:700;}
  
  input,select{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(0,0,0,0.3);color:var(--text);width:100%; margin-bottom: 10px;}
  label {font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px;}
  .side-panel{display:flex;flex-direction:column;gap:12px;}
  .orders-list { display:flex; flex-direction:column; gap:10px; }
  .order-item{padding:10px; background:rgba(255,255,255,0.06); border-radius:8px; margin-bottom:8px; border:1px solid rgba(255,255,255,0.05);}
  .w-row { display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.02); margin-bottom:5px; border-radius:6px;}

  /* --- TOGGLE SWITCH STYLES --- */
  .switch-container { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); margin-top: 10px; }
  .switch { position: relative; display: inline-block; width: 46px; height: 24px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 24px; }
  .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--active); }
  input:focus + .slider { box-shadow: 0 0 1px var(--active); }
  input:checked + .slider:before { transform: translateX(22px); }
  #statusLabel { font-weight: 800; font-size: 14px; }
</style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo-mark">TSS</div>
      <button class="nav-btn active" data-panel="panel-dashboard"><i class="fas fa-tachometer-alt"></i><div class="nav-label">Dashboard</div></button>
      <button class="nav-btn" data-panel="panel-products"><i class="fas fa-boxes"></i><div class="nav-label">Products</div></button>
      <button class="nav-btn" data-panel="panel-add"><i class="fas fa-plus"></i><div class="nav-label">Add</div></button>
      <button class="nav-btn" data-panel="panel-orders"><i class="fas fa-box-open"></i><div class="nav-label">Orders</div></button>
      <button class="nav-btn" data-panel="panel-withdraw"><i class="fas fa-wallet"></i><div class="nav-label">Withdraw</div></button>
      <button class="nav-btn" data-panel="panel-profile"><i class="fas fa-user-circle"></i><div class="nav-label">Profile</div></button>
      <div style="flex:1"></div>
      <button class="nav-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><div class="nav-label">Logout</div></button>
    </aside>

    <main class="main">
      <header>
        <div class="header-left">
          <div><div class="shop-title" id="headerShopName">Loading...</div><div class="nav-label" style="text-align:left" id="headerShopSub">Shopkeeper</div></div>
        </div>
        <button class="btn ghost" onclick="window.location.href='view.html'">Preview Shop</button>
      </header>

      <div class="content">
        <div id="panels" style="height:100%;overflow:auto">
          
          <section id="panel-dashboard" class="card" style="display:block;">
            <div class="kpis">
              <div class="kpi"><label>Wallet Balance</label><div class="val" id="statWallet">Ksh 0.00</div></div>
              <div class="kpi"><label>Total Sales</label><div class="val" id="statEarnings">Ksh 0</div></div>
              <div class="kpi"><label>Orders</label><div class="val" id="statOrders">0</div></div>
            </div>

            <div class="card" style="margin-top:20px; background:rgba(43,231,255,0.05)">
              <div class="panel-title">Quick Withdraw</div>
              <div style="display:grid; gap:10px; grid-template-columns: 1fr 1fr auto;">
                <div><label>M-Pesa Number</label><input id="quickPhone" placeholder="e.g. 0712345678" style="margin:0;"></div>
                <div><label>Amount</label><input id="quickAmount" type="number" placeholder="Amount" style="margin:0;"></div>
                <div style="display:flex; align-items:flex-end;"><button class="btn" onclick="requestWithdraw('quick')">Request</button></div>
              </div>
            </div>
          </section>

          <section id="panel-products" class="card" style="display:none">
            <div class="panel-title">Products <button class="btn ghost" style="font-size:12px" onclick="document.querySelector('[data-panel=\'panel-add\']').click()">+ Add</button></div>
            <div id="productsGrid">Loading...</div>
          </section>

          <section id="panel-add" class="card" style="display:none">
            <div class="panel-title">Add Product</div>
            <label>Product Name</label><input id="p_name" placeholder="e.g. Mens Sneakers">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div><label>Price (Ksh)</label><input id="p_price" type="number"></div>
              <div><label>Stock</label><input id="p_stock" type="number"></div>
            </div>
            <label>Product Image</label>
            <input type="file" id="p_file" accept="image/*">
            <div style="text-align:center; margin:5px 0; font-size:12px;">OR</div>
            <input id="p_image_url" placeholder="Paste Image URL">
            <button class="btn" id="p_save" style="width:100%; margin-top:10px;">Save Product</button>
          </section>

          <section id="panel-orders" class="card" style="display:none">
            <div class="panel-title">Orders</div>
            <div id="ordersList" class="orders-list">Loading...</div>
          </section>

          <section id="panel-withdraw" class="card" style="display:none">
            <div class="panel-title">Withdrawal History</div>
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-bottom:20px;">
              <h3 style="margin:0 0 10px 0; font-size:16px;">New Request</h3>
              <label>M-Pesa Number</label><input id="fullPhone" placeholder="e.g. 0712345678">
              <label>Amount (Ksh)</label><input id="fullAmount" type="number" placeholder="e.g. 1000">
              <button class="btn" onclick="requestWithdraw('full')" style="width:100%">Request Withdrawal</button>
            </div>
            <div class="panel-title" style="font-size:16px;">History</div>
            <div id="fullWithdrawList">Loading...</div>
          </section>

          <section id="panel-profile" class="card" style="display:none">
            <div class="panel-title">Edit Profile</div>
            <div style="text-align:center; margin-bottom:20px;">
              <img id="profilePreview" src="https://via.placeholder.com/100" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid var(--g1);">
              <br>
              <label for="profileFile" class="btn ghost" style="display:inline-block; margin-top:10px; cursor:pointer;">Change Photo</label>
              <input type="file" id="profileFile" accept="image/*" style="display:none">
            </div>
            <label>Shop Name</label><input id="prof_shopName">
            <label>Phone Number</label><input id="prof_phone">
            <label>Category</label>
            <select id="prof_category">
              <option value="General">General</option><option value="Fashion">Fashion</option><option value="Electronics">Electronics</option><option value="Food">Food</option>
            </select>
            <button class="btn" id="prof_save" style="width:100%">Update Profile</button>
          </section>

        </div>

        <aside class="side-panel">
          
          <div class="card">
            <div class="panel-title" style="font-size:14px; margin-bottom:5px;">Shop Status</div>
            <div class="switch-container">
              <span id="statusLabel" style="color:var(--danger);">CLOSED</span>
              <label class="switch">
                <input type="checkbox" id="shopStatusToggle">
                <span class="slider"></span>
              </label>
            </div>
            <div style="font-size:10px; color:var(--muted); margin-top:5px;">Turn OFF to hide shop from customers.</div>
          </div>

          <div class="card">
            <div class="panel-title" style="font-size:14px">Recent Activity</div>
            <div id="recentActivity" style="font-size:12px; color:var(--muted)">Loading...</div>
          </div>
          <div class="card">
            <div class="panel-title" style="font-size:14px">Wallet</div>
             <div style="font-size:20px; font-weight:800; margin-bottom:10px;" id="sideWallet">Ksh 0</div>
            <div id="sideWithdrawList" style="font-size:12px; color:var(--muted); max-height:200px; overflow:auto;"></div>
          </div>
        </aside>
      </div>
    </main>
  </div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCws2eOt3muKCpjHIxB3vUlOHGA06xLhtc",
  authDomain: "time-shop-save.firebaseapp.com",
  projectId: "time-shop-save",
  storageBucket: "time-shop-save.firebasestorage.app",
  messagingSenderId: "1037284454386",
  appId: "1:1037284454386:web:a863e690cc63049e1cc56b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let walletBalance = 0;

// --- AUTH & INIT ---
auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUser = user;
    loadProfile();
    loadProducts();
    loadOrdersAndWallet();
    setupRealtimeWithdrawals();
    listenForShopStatus(); // NEW LISTENER
  } else {
    window.location.href = 'shopkeeper-login.html';
  }
});

// --- NAVIGATION ---
const panels = document.querySelectorAll('#panels > section');
const navBtns = document.querySelectorAll('.nav-btn');
navBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    if(btn.id === 'logoutBtn') { auth.signOut(); return; }
    navBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const target = btn.dataset.panel;
    panels.forEach(p => p.style.display = 'none');
    document.getElementById(target).style.display = 'block';
  });
});

const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
});

// --- NEW: SHOP STATUS TOGGLE LOGIC ---
function listenForShopStatus() {
  const toggle = document.getElementById('shopStatusToggle');
  const label = document.getElementById('statusLabel');
  
  // Real-time listener for status
  db.collection('shopkeepers').doc(currentUser.uid).onSnapshot(doc => {
    if(doc.exists) {
      const data = doc.data();
      const isActive = data.status === 'Active';
      
      // Update UI
      toggle.checked = isActive;
      label.textContent = isActive ? 'OPEN' : 'CLOSED';
      label.style.color = isActive ? 'var(--active)' : 'var(--danger)';
    }
  });

  // Handle Change
  toggle.addEventListener('change', async (e) => {
    const newStatus = e.target.checked ? 'Active' : 'Inactive';
    // Optimistic UI
    label.textContent = newStatus === 'Active' ? 'OPEN' : 'CLOSED';
    label.style.color = newStatus === 'Active' ? 'var(--active)' : 'var(--danger)';
    
    try {
      await db.collection('shopkeepers').doc(currentUser.uid).set({ status: newStatus }, { merge: true });
    } catch(err) {
      console.error(err);
      alert("Failed to update status");
      e.target.checked = !e.target.checked; // Revert switch if failed
    }
  });
}

// --- REAL-TIME WITHDRAWALS ---
function setupRealtimeWithdrawals() {
  db.collection("withdrawals")
    .where("shopOwnerEmail", "==", currentUser.email)
    .onSnapshot((snapshot) => {
      const fullList = document.getElementById('fullWithdrawList');
      const sideList = document.getElementById('sideWithdrawList');
      let docs = [];
      let totalWithdrawn = 0;

      snapshot.forEach(doc => {
        const w = doc.data();
        totalWithdrawn += Number(w.amount);
        docs.push(w);
      });

      docs.sort((a,b) => new Date(b.date) - new Date(a.date));

      if(docs.length === 0) {
        fullList.innerHTML = "No history.";
        sideList.innerHTML = "No history.";
        return;
      }

      let html = "";
      docs.forEach(w => {
        let color = w.status === 'pending' ? '#f59e0b' : (w.status === 'completed' ? '#10b981' : '#ef4444');
        let statusIcon = w.status === 'pending' ? '<i class="fas fa-clock"></i>' : '<i class="fas fa-check-circle"></i>';
        html += `
          <div class="w-row">
            <div>
              <span style="font-weight:bold; font-size:14px; color:#fff;">Ksh ${w.amount}</span><br>
              <span style="font-size:11px; color:var(--muted)"><i class="fas fa-mobile-alt"></i> ${w.mpesaNumber}</span>
            </div>
            <div style="text-align:right">
               <span style="color:${color}; font-weight:bold; font-size:12px;">${statusIcon} ${w.status.toUpperCase()}</span><br>
               <span style="font-size:10px; color:var(--muted)">${new Date(w.date).toLocaleDateString()}</span>
            </div>
          </div>`;
      });
      fullList.innerHTML = html;
      sideList.innerHTML = html;
      window.totalWithdrawn = totalWithdrawn;
      updateWalletDisplay();
    });
}

window.requestWithdraw = async (type) => {
  const prefix = type === 'quick' ? 'quick' : 'full';
  const phoneInput = document.getElementById(prefix+'Phone');
  const amtInput = document.getElementById(prefix+'Amount');
  const phone = phoneInput.value;
  const amount = Number(amtInput.value);

  if(!amount || amount <= 0) return alert("Invalid Amount");
  if(!phone) return alert("Enter M-Pesa Number");
  if(amount > walletBalance) return alert("Insufficient Balance! Current: Ksh " + walletBalance);

  if(!confirm(`Confirm withdraw of Ksh ${amount} to ${phone}?`)) return;

  try {
    await db.collection("withdrawals").add({
      shopOwnerEmail: currentUser.email,
      shopId: currentUser.uid,
      amount: amount,
      mpesaNumber: phone,
      status: 'pending',
      date: new Date().toISOString()
    });
    alert("Request Sent!");
    phoneInput.value = '';
    amtInput.value = '';
  } catch(e) { alert(e.message); }
}

// --- PROFILE ---
async function loadProfile() {
  try {
    let doc = await db.collection('shopkeepers').doc(currentUser.uid).get();
    if(!doc.exists) doc = await db.collection('users').doc(currentUser.uid).get();
    if(doc.exists){
      const data = doc.data();
      document.getElementById('headerShopName').textContent = data.shopName || "My Shop";
      document.getElementById('prof_shopName').value = data.shopName || "";
      document.getElementById('prof_phone').value = data.phone || "";
      if(data.phone) {
        document.getElementById('quickPhone').value = data.phone;
        document.getElementById('fullPhone').value = data.phone;
      }
      document.getElementById('prof_category').value = data.category || "General";
      if(data.logo) document.getElementById('profilePreview').src = data.logo;
    }
  } catch(e){ console.log("Profile load error", e); }
}

document.getElementById('profileFile').addEventListener('change', async (e) => {
  if(e.target.files[0]){
    const base64 = await toBase64(e.target.files[0]);
    document.getElementById('profilePreview').src = base64;
  }
});
document.getElementById('prof_save').addEventListener('click', async () => {
  const btn = document.getElementById('prof_save');
  btn.textContent = "Updating...";
  const shopName = document.getElementById('prof_shopName').value;
  const phone = document.getElementById('prof_phone').value;
  const category = document.getElementById('prof_category').value;
  const imgFile = document.getElementById('profileFile').files[0];
  let updateData = { shopName, phone, category };
  if(imgFile) updateData.logo = await toBase64(imgFile);
  await db.collection('shopkeepers').doc(currentUser.uid).set(updateData, { merge: true });
  alert("Profile Updated!");
  btn.textContent = "Update Profile";
  loadProfile();
});

// --- PRODUCTS ---
document.getElementById('p_save').addEventListener('click', async () => {
  const name = document.getElementById('p_name').value;
  const price = document.getElementById('p_price').value;
  const stock = document.getElementById('p_stock').value;
  const urlInput = document.getElementById('p_image_url').value;
  const fileInput = document.getElementById('p_file').files[0];
  if(!name || !price) return alert("Name and Price required");
  const btn = document.getElementById('p_save');
  btn.textContent = "Saving...";
  btn.disabled = true;
  try {
    let finalImg = urlInput;
    if(fileInput) finalImg = await toBase64(fileInput);
    await db.collection("products").add({
      name, price: Number(price), stock: Number(stock), img: finalImg,
      ownerEmail: currentUser.email,
      shopName: document.getElementById('headerShopName').textContent,
      createdAt: new Date().toISOString()
    });
    alert("Product Added!");
    document.getElementById('p_name').value = '';
    loadProducts();
    document.querySelector('[data-panel="panel-products"]').click();
  } catch(e) { alert("Error: " + e.message); }
  btn.textContent = "Save Product";
  btn.disabled = false;
});

async function loadProducts() {
  const grid = document.getElementById('productsGrid');
  const snap = await db.collection("products").where("ownerEmail", "==", currentUser.email).get();
  grid.innerHTML = '';
  if(snap.empty) { grid.innerHTML = "No products."; return; }
  snap.forEach(doc => {
    const p = doc.data();
    grid.innerHTML += `<div class="product"><img src="${p.img || 'https://via.placeholder.com/60'}"><div style="flex:1"><b>${p.name}</b><br><small>Ksh ${p.price} | Stock: ${p.stock}</small></div><button class="btn ghost" style="color:red; border-color:red;" onclick="delProd('${doc.id}')"><i class="fas fa-trash"></i></button></div>`;
  });
}
window.delProd = async(id) => { if(confirm("Delete?")) { await db.collection("products").doc(id).delete(); loadProducts(); } }

// --- ORDERS ---
async function loadOrdersAndWallet() {
  const list = document.getElementById('ordersList');
  const recent = document.getElementById('recentActivity');
  try {
    const snap = await db.collection("orders").where("shopOwnerEmail", "==", currentUser.email).get();
    let docs = [];
    let totalEarnings = 0;
    snap.forEach(doc => {
      const o = doc.data();
      totalEarnings += Number(o.total || 0);
      docs.push(o);
    });
    docs.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
    document.getElementById('statOrders').textContent = docs.length;
    list.innerHTML = ''; recent.innerHTML = '';
    if(docs.length === 0) {
      list.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">No orders yet.</div>';
    } else {
      docs.forEach(o => {
        const itemHtml = `<div class="order-item"><div><span style="font-weight:bold; color:#fff;">${o.customerEmail || 'Guest'}</span><br><span style="font-size:12px; color:#ccc;">${(o.items||[]).map(i=>i.name + ' (x'+i.qty+')').join(', ')}</span></div><div style="text-align:right"><span style="color:var(--active); font-weight:bold;">+ Ksh ${o.total}</span><br><span style="font-size:10px; color:var(--muted)">${o.status || 'Paid'}</span></div></div>`;
        list.insertAdjacentHTML('beforeend', itemHtml);
        recent.insertAdjacentHTML('beforeend', itemHtml);
      });
    }
    document.getElementById('statEarnings').textContent = "Ksh " + totalEarnings;
    window.totalEarnings = totalEarnings;
    updateWalletDisplay();
  } catch(e) { console.error("Order Error:", e); }
}

function updateWalletDisplay() {
  const earnings = window.totalEarnings || 0;
  const withdrawn = window.totalWithdrawn || 0;
  walletBalance = earnings - withdrawn;
  const txt = "Ksh " + walletBalance.toLocaleString();
  document.getElementById('statWallet').textContent = txt;
  document.getElementById('sideWallet').textContent = txt;
}
</script>
</body>
</html>