<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Time Shop Save â€” Explore</title>

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%237b2ff7'/><stop offset='1' stop-color='%23ff6ec7'/></linearGradient></defs><rect width='100' height='100' rx='16' fill='url(%23g)'/><text x='50' y='60' font-family='Inter,Arial,sans-serif' font-weight='800' font-size='28' text-anchor='middle' fill='%23070416'>TSS</text></svg>">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700,800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --bg1:#070416; --accent:#7b2ff7; --text:#eaf3ff; --muted:rgba(234,243,255,0.65);
      --card-bg:rgba(255,255,255,0.05); --card-shadow:0 6px 20px rgba(0,0,0,0.4);
      --accent-grad:linear-gradient(90deg,#7b2ff7,#ff6ec7,#2be7ff);
      --active:#2be72b; --offline:#ff4b4b; --drawer-bg: #0f1020;
    }
    html,body { height:100%; margin:0; font-family:Inter,system-ui; color:var(--text); background:var(--bg1); overflow-x: hidden; }
    * {box-sizing:border-box;} a {color:inherit;text-decoration:none;}

    /* HEADER */
    header { padding:15px 20px; display:flex; align-items:center; gap:15px; position:sticky; top:0; background:rgba(7,4,22,0.95); backdrop-filter:blur(10px); z-index:50; border-bottom:1px solid rgba(255,255,255,0.08); }
    .menu-btn { font-size:20px; color:var(--text); cursor:pointer; }
    header h1 { margin:0; font-size:20px; background:var(--accent-grad); -webkit-background-clip:text; color:transparent; font-weight:800; flex:1; }
    
    /* SEARCH */
    .search-container { padding: 10px 20px; }
    .search-bar { display:flex; align-items:center; background:rgba(255,255,255,0.08); padding:10px 15px; border-radius:10px; }
    .search-bar input { flex:1; background:transparent; border:none; color:var(--text); font-size:15px; outline:none; margin-left:10px; }
    .search-bar i { color:var(--muted); }

    /* LOCATION BUTTON */
    .controls-row { padding: 0 20px 10px; display: flex; align-items: center; justify-content: space-between; }
    .loc-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: var(--muted); padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .loc-btn:hover { border-color: var(--accent); color: var(--text); }

    /* SIDE DRAWER (MENU) */
    .drawer-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:90; display:none; opacity:0; transition:opacity 0.3s; }
    .drawer { position:fixed; top:0; left:-280px; width:280px; height:100%; background:var(--drawer-bg); z-index:100; transition:left 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 4px 0 20px rgba(0,0,0,0.5); display:flex; flex-direction:column; }
    
    .drawer-header { padding: 30px 20px; background: var(--accent-grad); color: #000; }
    .drawer-user { font-weight: 800; font-size: 18px; margin-bottom: 4px; }
    .drawer-email { font-size: 13px; opacity: 0.8; }
    
    .drawer-links { padding: 20px 0; flex: 1; overflow-y: auto; }
    .drawer-link { padding: 15px 25px; display: flex; align-items: center; gap: 15px; color: var(--text); font-size: 15px; transition: 0.2s; cursor: pointer; }
    .drawer-link:hover { background: rgba(255,255,255,0.05); color: var(--accent); }
    .drawer-link i { width: 20px; text-align: center; color: var(--muted); }
    .drawer-link:hover i { color: var(--accent); }

    /* CATEGORIES */
    .categories { display:flex; overflow-x:auto; padding:10px 20px; gap:15px; scrollbar-width:none; -ms-overflow-style: none; }
    .categories::-webkit-scrollbar {display:none;}
    .category { flex:0 0 auto; display:flex; flex-direction:column; align-items:center; gap:8px; cursor:pointer; opacity:0.7; transition:0.2s; }
    .category.active, .category:hover { opacity:1; transform:translateY(-2px); }
    .cat-icon { width:56px; height:56px; background:rgba(255,255,255,0.08); border-radius:18px; display:flex; align-items:center; justify-content:center; font-size:20px; color:var(--accent); }
    .cat-name { font-size:11px; font-weight:500; white-space: nowrap; }

    /* SHOPS GRID */
    .shops { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:15px; padding:20px; padding-bottom:90px; }
    .shop-card { background:var(--card-bg); border-radius:16px; padding:15px; display:flex; flex-direction:column; align-items:center; position:relative; box-shadow:var(--card-shadow); transition:transform 0.2s; cursor:pointer; border:1px solid rgba(255,255,255,0.05); }
    .shop-card:hover { transform:translateY(-4px); border-color:var(--accent); }
    .shop-card img { width:70px; height:70px; border-radius:50%; margin-bottom:12px; object-fit:cover; border:2px solid rgba(255,255,255,0.1); }
    .shop-name { font-size:15px; font-weight:700; margin-bottom:4px; text-align:center; }
    .shop-category { font-size:12px; color:var(--muted); text-align:center; }
    .status-badge { position:absolute; top:10px; right:10px; padding:4px 8px; border-radius:20px; font-size:10px; font-weight:700; color:#000; }
    .closed { opacity: 0.6; filter: grayscale(1); }

    /* BOTTOM NAV */
    .bottom-nav { position:fixed; bottom:0; width:100%; display:flex; justify-content:space-around; background:rgba(7,4,22,0.98); padding:12px 0; border-top:1px solid rgba(255,255,255,0.08); backdrop-filter:blur(10px); z-index:40; }
    .bottom-nav a { display:flex; flex-direction:column; align-items:center; font-size:10px; color:var(--muted); gap:4px; transition: 0.2s; }
    .bottom-nav a.active { color:var(--accent); }
    .bottom-nav i { font-size:20px; }

    /* States */
    .drawer-open .drawer { left: 0; }
    .drawer-open .drawer-overlay { display: block; opacity: 1; }
  </style>
</head>
<body>

<div class="drawer-overlay" onclick="toggleDrawer()"></div>
<aside class="drawer">
  <div class="drawer-header">
    <div class="drawer-user" id="drawerUser">Hello, Guest</div>
    <div class="drawer-email" id="drawerEmail">Sign in to sync</div>
  </div>
  <div class="drawer-links">
    <div class="drawer-link" onclick="window.location.href='index.html'"><i class="fas fa-home"></i> Home</div>
    <div class="drawer-link" onclick="window.location.href='profile.html'"><i class="fas fa-user"></i> My Profile</div>
    <div class="drawer-link" onclick="window.location.href='orders.html'"><i class="fas fa-box"></i> My Orders</div>
    <div class="drawer-link" onclick="alert('Wallet coming soon!')"><i class="fas fa-wallet"></i> Wallet</div>
    <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:10px 0;">
    <div class="drawer-link" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> <span id="logoutText">Logout</span></div>
  </div>
</aside>

<header>
  <i class="fas fa-bars menu-btn" onclick="toggleDrawer()"></i>
  <h1>TSS Explore</h1>
  <i class="fas fa-shopping-cart menu-btn" onclick="window.location.href='orders.html'"></i>
</header>

<div class="search-container">
  <div class="search-bar">
    <i class="fas fa-search"></i>
    <input type="text" id="searchInput" placeholder="Search for shops, items..." />
  </div>
</div>

<div class="controls-row">
  <button id="useLocationBtn" class="loc-btn"><i class="fas fa-map-marker-alt"></i> Near Me</button>
  <div id="locationStatus" style="color:var(--muted);font-size:11px"></div>
</div>

<div class="categories" id="categories">
  </div>

<div class="shops" id="shopContainer">
  <div style="text-align:center;color:var(--muted);grid-column:1/-1;padding:40px;">
    <i class="fas fa-circle-notch fa-spin"></i> Loading shops...
  </div>
</div>

<div class="bottom-nav">
  <a href="index.html"><i class="fas fa-home"></i>Home</a>
  <a href="explore.html" class="active"><i class="fas fa-compass"></i>Explore</a>
  <a href="orders.html"><i class="fas fa-receipt"></i>Orders</a>
  <a href="profile.html"><i class="fas fa-user"></i>Profile</a>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyCws2eOt3muKCpjHIxB3vUlOHGA06xLhtc",
  authDomain: "time-shop-save.firebaseapp.com",
  projectId: "time-shop-save",
  storageBucket: "time-shop-save.firebasestorage.app",
  messagingSenderId: "1037284454386",
  appId: "1:1037284454386:web:a863e690cc63049e1cc56b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// UI LOGIC
function toggleDrawer() { document.body.classList.toggle('drawer-open'); }

// AUTH STATE
auth.onAuthStateChanged(user => {
  if(user) {
    document.getElementById('drawerUser').textContent = "Welcome Back!";
    document.getElementById('drawerEmail').textContent = user.email;
    document.getElementById('logoutText').textContent = "Logout";
  } else {
    document.getElementById('drawerUser').textContent = "Hello, Guest";
    document.getElementById('drawerEmail').textContent = "Tap to Login";
    document.getElementById('logoutText').textContent = "Login";
  }
});

function handleLogout() {
  const txt = document.getElementById('logoutText').textContent;
  if(txt === 'Login') window.location.href = 'customer-login.html';
  else auth.signOut().then(() => window.location.href = 'customer-login.html');
}

// FULL CATEGORIES LIST
const categoriesData = [
  {name:'All', icon:'fas fa-globe'}, {name:'Shop', icon:'fas fa-store'},
  {name:'Supermarket', icon:'fas fa-shopping-basket'}, {name:'Grocery', icon:'fas fa-apple-alt'},
  {name:'Electronics', icon:'fas fa-tv'}, {name:'Fashion', icon:'fas fa-tshirt'},
  {name:'Pharmacy', icon:'fas fa-pills'}, {name:'Bakery', icon:'fas fa-bread-slice'},
  {name:'Restaurants', icon:'fas fa-utensils'}, {name:'Beauty', icon:'fas fa-magic'},
  {name:'Sports', icon:'fas fa-football-ball'}, {name:'Books', icon:'fas fa-book'},
  {name:'Hardware', icon:'fas fa-tools'}, {name:'Gifts', icon:'fas fa-gift'},
  {name:'Mobile', icon:'fas fa-mobile-alt'}, {name:'Food', icon:'fas fa-hamburger'},
  {name:'Barbershop', icon:'fas fa-cut'}, {name:'Salon', icon:'fas fa-spa'},
  {name:'Butchery', icon:'fas fa-drumstick-bite'}, {name:'Other', icon:'fas fa-ellipsis-h'}
];

const catContainer = document.getElementById('categories');
categoriesData.forEach(cat => {
  const div = document.createElement('div');
  div.className = 'category';
  // Use the icon class directly from data
  div.innerHTML = `<div class="cat-icon"><i class="${cat.icon}"></i></div><div class="cat-name">${cat.name}</div>`;
  div.addEventListener('click', () => renderShops(cat.name));
  catContainer.appendChild(div);
});

// SHOPS LOGIC
const shopContainer = document.getElementById('shopContainer');
let allShops = [];

async function loadShops() {
  try {
    let snapshot = await db.collection("shopkeepers").get();
    if (snapshot.empty) snapshot = await db.collection("users").where("role", "==", "shop").get();

    allShops = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      // Ensure we catch the status, defaulting to Active if not set
      const status = data.status || "Active";
      
      allShops.push({
        name: data.shopName || data.name || "Unknown Shop",
        category: data.category || "Other",
        logo: data.logo || "https://via.placeholder.com/150",
        email: data.email,
        status: status
      });
    });
    renderShops("All");
  } catch(e) {
    shopContainer.innerHTML = `<p style="text-align:center;color:red;grid-column:1/-1;">Error loading shops: ${e.message}</p>`;
  }
}

function renderShops(filter='All', searchTerm='') {
  shopContainer.innerHTML = '';
  let filtered = allShops;

  if(filter !== 'All') filtered = filtered.filter(s => (s.category || '').toLowerCase() === filter.toLowerCase());
  if(searchTerm) {
    const q = searchTerm.toLowerCase();
    filtered = filtered.filter(s => s.name.toLowerCase().includes(q));
  }

  if(!filtered.length) {
    shopContainer.innerHTML = `<p style="text-align:center;opacity:0.6;grid-column:1/-1;">No shops found.</p>`;
    return;
  }

  filtered.forEach(shop => {
    const isActive = shop.status === 'Active';
    const statusText = isActive ? 'OPEN' : 'CLOSED';
    const statusColor = isActive ? 'var(--active)' : 'var(--offline)';
    const cardClass = isActive ? 'shop-card' : 'shop-card closed';

    const div = document.createElement('div');
    div.className = cardClass;
    div.innerHTML = `
      <div class="status-badge" style="background:${statusColor}">${statusText}</div>
      <img src="${shop.logo}" alt="${shop.name}">
      <div class="shop-name">${shop.name}</div>
      <div class="shop-category">${shop.category}</div>
    `;
    
    div.onclick = () => {
      if(!isActive) {
        alert("This shop is currently closed.");
        return;
      }
      localStorage.setItem('currentShop', JSON.stringify({shopName: shop.name}));
      window.location.href = `shop.html?shop=${encodeURIComponent(shop.name)}`;
    };
    shopContainer.appendChild(div);
  });
}

// SEARCH
document.getElementById('searchInput').addEventListener('input', (e) => renderShops('All', e.target.value));

// Init
loadShops();
</script>
</body>
</html>