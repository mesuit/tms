<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop â€” Time Shop Save</title>

  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%237b2ff7'/><stop offset='1' stop-color='%23ff6ec7'/></linearGradient></defs><rect width='100' height='100' rx='16' fill='url(%23g)'/><text x='50' y='60' font-family='Inter,Arial,sans-serif' font-weight='800' font-size='28' text-anchor='middle' fill='%23070416'>TSS</text></svg>">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700,800&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* Exact existing style */
    :root{--bg1:#070416;--accent:#7b2ff7;--text:#eaf3ff;--muted:rgba(234,243,255,0.7);--card-bg:rgba(255,255,255,0.04);--accent-grad:linear-gradient(90deg,#7b2ff7,#ff6ec7,#2be7ff);--active:#2be72b;--offline:#ff4b4b;--cart-orange:#d94d1f;}html,body{margin:0;font-family:Inter,system-ui;color:var(--text);background:var(--bg1);}header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.1);background:rgba(7,4,22,0.9);position:sticky;top:0;z-index:10;}header h1{margin:0;font-size:18px;background:var(--accent-grad);-webkit-background-clip:text;color:transparent;font-weight:700;}.back-btn{display:flex;align-items:center;gap:6px;font-size:15px;color:var(--muted);background:none;border:none;cursor:pointer;transition:all 0.3s;}.back-btn:hover{color:var(--accent);transform:translateX(-3px);}.cart-svg-wrap{width:42px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;}.cart-count{position:absolute;top:-6px;right:-6px;background:var(--cart-orange);color:#fff;border-radius:50%;font-size:11px;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,0.4);}.shop-info{text-align:center;padding:30px 16px 10px;}.shop-info img{width:100px;height:100px;border-radius:20px;border:2px solid rgba(255,255,255,0.08);object-fit:cover;margin-bottom:10px;}.shop-name{font-size:22px;font-weight:700;}.shop-category{font-size:14px;color:var(--muted);margin:6px 0;}.shop-status{display:inline-block;margin-top:6px;padding:4px 12px;border-radius:8px;font-size:12px;font-weight:600;color:#071126;background:var(--active);}.offline{background:var(--offline)!important;}.search-bar{display:flex;justify-content:center;align-items:center;gap:8px;margin:14px auto 20px;width:90%;max-width:400px;}.search-bar input{flex:1;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:8px 12px;color:var(--text);font-size:14px;outline:none;transition:border 0.3s;}.search-bar input:focus{border-color:var(--accent);}.search-bar button{background:var(--accent-grad);border:none;border-radius:8px;padding:8px 14px;color:#fff;font-weight:600;cursor:pointer;transition:opacity 0.3s;}.search-bar button:hover{opacity:0.9;}.products{padding:10px 16px 80px;display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:14px;}.product-card{background:var(--card-bg);border-radius:16px;padding:10px;text-align:center;transition:transform 0.2s,box-shadow 0.2s;}.product-card:hover{transform:translateY(-3px);box-shadow:0 4px 12px rgba(123,47,247,0.25);}.product-card img{width:100%;height:130px;border-radius:12px;object-fit:cover;}.product-name{margin-top:6px;font-weight:600;font-size:14px;}.product-price{color:var(--accent);font-weight:700;font-size:14px;margin:4px 0;}.qty-controls{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:6px;}.qty-btn{background:var(--accent-grad);color:#fff;border:none;border-radius:8px;padding:4px 10px;font-weight:700;cursor:pointer;transition:opacity 0.3s;}.qty-btn:hover{opacity:0.85;}.qty-num{min-width:20px;font-weight:600;font-size:14px;}.no-products{text-align:center;color:var(--muted);margin-top:50px;font-size:15px;}.inactive-note{text-align:center;color:var(--offline);margin-top:25px;font-size:14px;font-weight:600;}.bottom-nav{position:fixed;bottom:0;width:100%;display:flex;justify-content:space-around;background:rgba(7,4,22,0.9);padding:8px 0;border-top:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(10px);}.bottom-nav a{display:flex;flex-direction:column;align-items:center;font-size:12px;color:var(--muted);}.bottom-nav a.active{color:var(--accent);}.bottom-nav i{font-size:18px;margin-bottom:2px;}
  </style>
</head>
<body>

<header>
  <button class="back-btn" onclick="window.location.href='explore.html'">Back</button>
  <h1 id="shopHeader">Shop</h1>
  <div class="cart-svg-wrap" id="cartIcon">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="#fff"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
    <div class="cart-count" id="cartCount">0</div>
  </div>
</header>

<div class="shop-info">
  <img id="shopLogo" src="https://via.placeholder.com/100" alt="Shop Logo">
  <div class="shop-name" id="shopName">Loading...</div>
  <div class="shop-status" id="shopStatus">Active</div>
</div>

<div class="search-bar">
  <input type="text" id="searchInput" placeholder="Search products...">
  <button id="searchBtn">Search</button>
</div>

<div class="products" id="productList">
  <div style="text-align:center;padding:20px;color:var(--muted)">Loading products from cloud...</div>
</div>

<div class="bottom-nav">
  <a href="index.html">Home</a>
  <a href="explore.html" class="active">Explore</a>
  <a href="orders.html">Orders</a>
  <a href="profile.html">Profile</a>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCws2eOt3muKCpjHIxB3vUlOHGA06xLhtc",
  authDomain: "time-shop-save.firebaseapp.com",
  projectId: "time-shop-save",
  storageBucket: "time-shop-save.firebasestorage.app",
  messagingSenderId: "1037284454386",
  appId: "1:1037284454386:web:a863e690cc63049e1cc56b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Get shop name from URL or local storage
const params = new URLSearchParams(window.location.search);
let targetShopName = decodeURIComponent(params.get('shop') || '');
if(!targetShopName && localStorage.getItem('currentShop')){
  try {
    const s = JSON.parse(localStorage.getItem('currentShop'));
    targetShopName = s.shopName;
  } catch(e) {
    targetShopName = localStorage.getItem('currentShop');
  }
}

if(targetShopName){
  document.getElementById('shopName').textContent = targetShopName;
  document.getElementById('shopHeader').textContent = targetShopName;
  loadShopProducts(targetShopName);
} else {
  alert("No shop selected");
  window.location.href = "explore.html";
}

async function loadShopProducts(shopName){
  const list = document.getElementById('productList');
  
  // Query Cloud Firestore
  try {
    const q = db.collection("products").where("shopName", "==", shopName);
    const snapshot = await q.get();

    list.innerHTML = '';
    if(snapshot.empty){
      list.innerHTML = '<div class="no-products">No products found in this shop.</div>';
      return;
    }

    const cart = JSON.parse(localStorage.getItem('cart_' + shopName) || '[]');

    snapshot.forEach(doc => {
      const p = doc.data();
      // Check if in cart
      const inCart = cart.find(x => x.name === p.name);
      const qty = inCart ? inCart.qty : 0;

      const div = document.createElement('div');
      div.className = 'product-card';
      div.innerHTML = `
        <img src="${p.img || 'https://via.placeholder.com/300'}" alt="img">
        <div class="product-name">${p.name}</div>
        <div class="product-price">Ksh ${p.price}</div>
        <div class="qty-controls">
          <button class="qty-btn minus" onclick="updateCart('${p.name}', ${p.price}, -1)">-</button>
          <span class="qty-num">${qty}</span>
          <button class="qty-btn plus" onclick="updateCart('${p.name}', ${p.price}, 1, '${p.img}', '${p.ownerEmail}')">+</button>
        </div>
      `;
      list.appendChild(div);
    });
    updateCartCount();
  } catch(e) {
    console.error(e);
    list.innerHTML = `<div style="text-align:center;color:red">Error loading: ${e.message}</div>`;
  }
}

function updateCart(name, price, change, img, ownerEmail){
  const key = 'cart_' + targetShopName;
  let cart = JSON.parse(localStorage.getItem(key) || '[]');
  let item = cart.find(x => x.name === name);

  if(change > 0){
    if(item) item.qty++;
    else cart.push({ name, price, qty: 1, img: img || '', ownerEmail: ownerEmail });
  } else {
    if(item) {
      item.qty--;
      if(item.qty <= 0) cart = cart.filter(x => x.name !== name);
    }
  }
  
  localStorage.setItem(key, JSON.stringify(cart));
  loadShopProducts(targetShopName); // re-render
}

function updateCartCount(){
  const key = 'cart_' + targetShopName;
  const cart = JSON.parse(localStorage.getItem(key) || '[]');
  const count = cart.reduce((sum, i) => sum + i.qty, 0);
  const el = document.getElementById('cartCount');
  el.textContent = count;
  el.style.display = count > 0 ? 'flex' : 'none';
}

document.getElementById('cartIcon').addEventListener('click', ()=>{
  window.location.href = `orders.html?shop=${encodeURIComponent(targetShopName)}`;
});
</script>
</body>
</html>